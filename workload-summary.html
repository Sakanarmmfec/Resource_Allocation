<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workload Summary - Resource Allocation</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 80px 20px 20px 20px;
            background: white;
            min-height: 100vh;
            font-size: 14px;
            color: #334155;
            opacity: 0;
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 32px;
            margin: 0 auto 0 60px;
            max-width: 1400px;
            border: 0.5px solid #e2e8f0;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease-out 0.2s forwards;
        }
        
        @keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .nav-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            color: #1e3a8a;
        }
        
        h1 {
            color: #1e3a8a;
            font-size: 28px;
            font-weight: 600;
            margin: 0 0 32px 0;
            text-align: center;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 32px;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease-out 0.8s forwards;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .metric-card.overloaded {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .metric-card.underutilized {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .summary-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease-out 0.4s forwards;
        }
        
        .section-title {
            color: #1e3a8a;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .employee-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .employee-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .employee-name {
            font-weight: 600;
            color: #1e3a8a;
            font-size: 16px;
        }
        
        .employee-dept {
            color: #6b7280;
            font-size: 12px;
        }
        
        .workload-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .workload-normal {
            background: #dcfce7;
            color: #166534;
        }
        
        .workload-high {
            background: #fef3c7;
            color: #92400e;
        }
        
        .workload-overloaded {
            background: #fecaca;
            color: #991b1b;
        }
        
        .workload-underutilized {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .project-list {
            margin-top: 12px;
        }
        
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
        }
        
        .project-item:last-child {
            border-bottom: none;
        }
        
        .project-name {
            color: #374151;
        }
        
        .project-effort {
            font-weight: 600;
            color: #1e3a8a;
        }
        
        .filters-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s ease-out 0.6s forwards;
        }
        
        .filters-header {
            background: #f8fafc;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .filters-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e3a8a;
            margin: 0;
        }
        
        .filters-content {
            padding: 24px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            width: 100%;
        }
        
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .refresh-btn {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        
        .refresh-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        
        .department-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .dept-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .dept-name {
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 12px;
        }
        
        .dept-stats {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
        }
        
        .dept-stat {
            text-align: center;
        }
        
        .dept-stat-value {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }
        
        .dept-stat-label {
            color: #6b7280;
            margin-top: 4px;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 16px;
        }
        
        .chart-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .chart-control label {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }
        
        .chart-control select {
            padding: 6px 10px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            overflow-x: auto;
        }
        
        .chart {
            display: flex;
            align-items: end;
            height: 350px;
            gap: 2px;
            padding: 20px 0;
            min-width: 100%;
        }
        
        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            flex: 1;
        }
        
        .bar {
            width: 100%;
            max-width: 50px;
            min-width: 20px;
            display: flex;
            flex-direction: column;
            justify-content: end;
            position: relative;
        }
        
        .bar-segment {
            width: 100%;
            min-height: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .bar-label {
            font-size: 10px;
            color: #6b7280;
            margin-top: 8px;
            text-align: center;
            transform: rotate(-45deg);
            white-space: nowrap;
        }
        
        .bar-value {
            font-size: 10px;
            font-weight: 600;
            color: #374151;
            margin-top: 4px;
            text-align: center;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .pie-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
        }
        
        .pie-slice {
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        
        .pie-slice:hover {
            opacity: 0.8;
        }
        
        /* Chat Bubble Styles */
        .chat-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .chat-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 1001;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 1001;
            border: 1px solid #e2e8f0;
        }
        
        .chat-header {
            background: #3b82f6;
            color: white;
            padding: 16px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message.user {
            background: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            background: #f1f5f9;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }
        
        .chat-input:focus {
            border-color: #3b82f6;
        }
        
        .chat-send {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: #f1f5f9;
            padding: 10px 14px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        @media (max-width: 768px) {
            .container { max-width: 100%; padding: 20px 15px; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
            .metric-card { padding: 16px; }
            .metric-value { font-size: 24px; }
            .employee-summary, .department-summary { grid-template-columns: 1fr; }
            .filter-row { grid-template-columns: 1fr; }
            .chart-container { margin-bottom: 16px; }
            .chart-wrapper { height: 300px; }
            .chat-window { width: 90%; height: 70vh; bottom: 10px; right: 5%; }
            table { font-size: 12px; }
            th, td { padding: 8px 6px !important; }
            h1 { font-size: 24px; }
            h2, h3 { font-size: 18px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 15px 10px; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .metric-card { padding: 12px; }
            .metric-value { font-size: 20px; }
            .filters-content { padding: 16px; }
            .chart-wrapper { height: 250px; }
            .chat-window { width: 95%; height: 60vh; }
            table { font-size: 11px; }
            th, td { padding: 6px 4px !important; }
            h1 { font-size: 20px; }
            h2, h3 { font-size: 16px; }
            .refresh-btn { padding: 8px 12px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <script src="menu-bar.js"></script>
    <div style="position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 12px; z-index: 999;">
        <span id="userInfo" style="color: #374151; font-weight: 500;"></span>
        <a id="adminLink" href="admin.html" style="background: #8b5cf6; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px; display: none;">🛡️ Admin</a>
        <button onclick="logout()" style="background: #ef4444; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px;">Logout</button>
    </div>
    <div class="container">
        <a href="index.html" class="nav-link">← Back to Home</a>
        
        <h1>📊 Workload Summary</h1>
        
        <div class="summary-section">
            <h2 class="section-title">📊 Overview Report</h2>
            
            <div class="filters-container" style="margin-bottom: 24px;">
                <div class="filters-header">
                    <h3 class="filters-title">🔍 Filters</h3>
                    <button class="refresh-btn" onclick="loadData()">🔄 Refresh</button>
                </div>
                <div class="filters-content">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>🏢 Department</label>
                            <select id="departmentFilter" onchange="filterData()">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>📅 Time Period</label>
                            <select id="periodFilter" onchange="filterData()">
                                <option value="all" selected>All Time</option>
                                <option value="month">Select Month</option>
                                <option value="week">Select Week</option>
                                <option value="year">Select Year</option>
                            </select>
                        </div>
                        <div class="filter-group" id="monthSelector" style="display: block;">
                            <label>📅 Month</label>
                            <input type="month" id="startMonth" onchange="filterData()">
                            <button onclick="setCurrentMonth()" style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 4px;">Current Month</button>
                        </div>
                        <div class="filter-group" id="weekSelector" style="display: none;">
                            <label>📆 Start Week</label>
                            <input type="week" id="startWeek" onchange="filterData()">
                            <button onclick="setCurrentWeek()" style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 4px;">Current Week</button>
                        </div>
                        <div class="filter-group" id="yearSelector" style="display: none;">
                            <label>📅 Year</label>
                            <select id="yearSelect" onchange="filterData()">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                            <button onclick="setCurrentYear()" style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 4px;">Current Year</button>
                        </div>
                        <div class="filter-group">
                            <label>👤 Employee</label>
                            <select id="employeeFilter" onchange="filterData()">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>📋 Project</label>
                            <select id="projectFilter" onchange="filterData()">
                                <option value="">All Projects</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="metrics-grid" id="metricsGrid" style="margin-bottom: 24px;">
                <!-- Metrics will be populated here -->
            </div>
            
            <div style="margin-bottom: 24px;">
                <h3 style="color: #1e3a8a; font-size: 18px; font-weight: 600; margin-bottom: 16px;">📊 Workload Visualization</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="chart-container">
                        <h4 style="color: #1e3a8a; font-size: 16px; font-weight: 600; margin-bottom: 16px;">📊 Bar Chart</h4>
                        <div class="chart-controls">
                            <div class="chart-control">
                                <label>Sort By</label>
                                <select id="sortBy" onchange="updateBarChart()">
                                    <option value="workload">Total Workload</option>
                                    <option value="name">Employee Name</option>
                                </select>
                            </div>
                            <div class="chart-control">
                                <label>View</label>
                                <select id="chartView" onchange="updateBarChart()">
                                    <option value="employee">By Employee</option>
                                    <option value="week">By Week</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart" id="workloadChart"></div>
                        </div>
                        <div class="legend" id="chartLegend"></div>
                    </div>
                    
                    <div class="chart-container">
                        <h4 style="color: #1e3a8a; font-size: 16px; font-weight: 600; margin-bottom: 16px;">🥧 Pie Chart</h4>
                        <div class="chart-controls">
                            <div class="chart-control">
                                <label>Show By</label>
                                <select id="pieView" onchange="updatePieChart()">
                                    <option value="employee">Employee</option>
                                    <option value="project">Project</option>
                                    <option value="department">Department</option>
                                    <option value="projecttype">Project Type</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="pie-chart" id="pieChart">
                                <svg width="400" height="400" id="pieSvg"></svg>
                            </div>
                        </div>
                        <div class="legend" id="pieLegend"></div>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 style="color: #1e3a8a; font-size: 18px; font-weight: 600; margin-bottom: 16px;">🏢 Department Overview</h3>
                <div class="department-summary" id="departmentSummary">
                    <!-- Department summary will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="summary-section">
            <h2 class="section-title">📊 Detailed Reports</h2>
            
            <div style="margin-bottom: 32px;">
                <h3 style="color: #1e3a8a; font-size: 18px; font-weight: 600; margin-bottom: 16px;">📋 Project Workload Details</h3>
                <div style="margin-bottom: 16px; display: flex; gap: 20px; align-items: center;">
                    <div>
                        <label style="font-weight: 600; color: #374151; margin-right: 12px;">View:</label>
                        <select id="projectViewType" onchange="renderProjectSummary()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="card">Card View</option>
                            <option value="table" selected>Table View</option>
                        </select>
                    </div>
                    <div>
                        <button onclick="downloadProjectExcel()" style="background: #10b981; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; width: fit-content;">Download Master</button>
                    </div>
                </div>
                <div class="project-summary" id="projectSummary">
                    <!-- Project summary will be populated here -->
                </div>
            </div>
            
            <div>
                <h3 style="color: #1e3a8a; font-size: 18px; font-weight: 600; margin-bottom: 16px;">👥 Employee Workload Status Details</h3>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Status</label>
                            <select id="statusFilter" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="all">All Employees</option>
                                <option value="normal">Normal</option>
                                <option value="overloaded">Overloaded</option>
                                <option value="underutilized">Underutilized</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Employee</label>
                            <select id="detailEmployeeFilter" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Department</label>
                            <select id="detailDepartmentFilter" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Time Period</label>
                            <select id="detailPeriodFilter" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="all">All Time</option>
                                <option value="month">Select Month</option>
                                <option value="week">Select Week</option>
                                <option value="year">Select Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Project</label>
                            <select id="detailProjectFilter" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="">All Projects</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div id="detailMonthSelector" style="display: none;">
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Month</label>
                            <input type="month" id="detailStartMonth" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                        </div>
                        <div id="detailWeekSelector" style="display: none;">
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Week</label>
                            <input type="week" id="detailStartWeek" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                        </div>
                        <div id="detailYearSelector" style="display: none;">
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Year</label>
                            <select id="detailYearSelect" onchange="filterEmployeesByStatus()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">View</label>
                            <select id="viewType" onchange="renderEmployeeSummary()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="card" selected>Card View</option>
                                <option value="table">Table View</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Export</label>
                            <button onclick="downloadExcel()" style="background: #10b981; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; width: fit-content;">Download Master</button>
                        </div>
                    </div>
                </div>
                <div class="employee-summary" id="employeeSummary">
                    <!-- Employee summary will be populated here -->
                </div>
            </div>
            
            <div style="margin-top: 32px;">
                <h3 style="color: #1e3a8a; font-size: 18px; font-weight: 600; margin-bottom: 16px;">📊 Employee Workload by Project</h3>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Status</label>
                            <select id="projectStatusFilter" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="all">All Employees</option>
                                <option value="normal">Normal</option>
                                <option value="overloaded">Overloaded</option>
                                <option value="underutilized">Underutilized</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Employee</label>
                            <select id="projectEmployeeFilter" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="">All Employees</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Department</label>
                            <select id="projectDepartmentFilter" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Time Period</label>
                            <select id="projectPeriodFilter" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="all">All Time</option>
                                <option value="month">Select Month</option>
                                <option value="week">Select Week</option>
                                <option value="year">Select Year</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Project</label>
                            <select id="projectProjectFilter" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="">All Projects</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div id="projectMonthSelector" style="display: none;">
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Month</label>
                            <input type="month" id="projectStartMonth" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                        </div>
                        <div id="projectWeekSelector" style="display: none;">
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Week</label>
                            <input type="week" id="projectStartWeek" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                        </div>
                        <div id="projectYearSelector" style="display: none;">
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Year</label>
                            <select id="projectYearSelect" onchange="renderProjectWorkload()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 100%;">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #374151; font-size: 12px; margin-bottom: 4px; display: block;">Export</label>
                            <button onclick="downloadProjectWorkloadExcel()" style="background: #10b981; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; width: fit-content;">Download Master</button>
                        </div>
                    </div>
                </div>
                <div id="projectWorkloadTable">
                    <!-- Project workload table will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Bubble -->
    <div class="chat-bubble" onclick="toggleChat()">
        <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>
    </div>
    
    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3 style="margin: 0; font-size: 16px;">🤖 AI Workload Assistant</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="clearConversation()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 12px; cursor: pointer; padding: 4px 8px; border-radius: 4px;" title="Clear conversation">🗑️</button>
                <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">×</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                Hi! I'm your AI-powered workload assistant. I use AI to verify and answer resource allocation questions:
                <br>• AI verifies if your question is related to resource allocation
                <br>• Analyzes employee availability and workload intelligently
                <br>• Provides smart insights about department and project data
                <br>• Uses AI to query the database and summarize results
                <br><br>Try asking: "Who is working on Project TISCO?" or "Which department has the highest workload?"
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about workload data...">
            <button class="chat-send" onclick="sendMessage()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : '/api';
        let employees = [];
        let projects = [];
        let efforts = [];
        let assignments = [];
        let currentDepartment = '';
        let currentPeriod = 'all';
        let currentEmployee = '';
        let currentProject = '';
        
        const projectColors = {
            'LInternal': '#3b82f6',
            'LPTTEP': '#ef4444', 
            'Project A': '#10b981',
            'Project B': '#f59e0b',
            'Project C': '#8b5cf6',
            'Project D': '#ec4899',
            'Project E': '#06b6d4',
            'Project F': '#84cc16'
        };
        
        let colorIndex = 0;
        const defaultColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

        async function loadData() {
            try {
                console.log('Loading data from API...');
                
                // Check if we're being redirected to login page
                if (window.location.href.includes('login.html')) {
                    console.log('Redirected to login, using offline mode');
                    loadOfflineData();
                    return;
                }
                
                const [empRes, projRes, effRes, assignRes] = await Promise.all([
                    fetch(`${API_BASE}/employees`, { credentials: 'include' }),
                    fetch(`${API_BASE}/projects`, { credentials: 'include' }),
                    fetch(`${API_BASE}/efforts`, { credentials: 'include' }),
                    fetch(`${API_BASE}/project-assignments`, { credentials: 'include' })
                ]);
                
                // Check if any response is not JSON (likely HTML login page)
                if (!empRes.ok || !projRes.ok || !effRes.ok || !assignRes.ok) {
                    console.log('API not available, using offline mode with sample data');
                    loadOfflineData();
                    // Ensure admin button is visible when API is not available
                    document.getElementById('adminLink').style.display = 'inline-block';
                    return;
                }
                
                employees = await empRes.json();
                projects = await projRes.json();
                efforts = await effRes.json();
                assignments = await assignRes.json();
                
                console.log('✅ Data loaded:', {
                    employees: employees.length,
                    projects: projects.length,
                    efforts: efforts.length,
                    assignments: assignments.length
                });
                
                // Debug chart data
                console.log('📊 Chart Debug - Sample data:');
                if (employees.length > 0) console.log('Sample employee:', employees[0]);
                if (efforts.length > 0) console.log('Sample effort:', efforts[0]);
                if (assignments.length > 0) console.log('Sample assignment:', assignments[0]);
                
                const filteredEmployees = getFilteredEmployees();
                console.log('Filtered employees for charts:', filteredEmployees.length);
                
                if (filteredEmployees.length > 0) {
                    const workload = getEmployeeWorkload(filteredEmployees[0].id);
                    console.log('Sample workload calculation:', workload);
                }
                
                if (employees.length === 0) {
                    document.getElementById('metricsGrid').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No employees found</div>';
                    return;
                }
                
                updateDepartmentFilter();
                updateEmployeeFilter();
                updateProjectFilter();
                calculateMetrics();
                updateBarChart();
                updatePieChart();
                renderDepartmentSummary();
                renderProjectSummary();
                renderEmployeeSummary();
            } catch (error) {
                console.error('❌ Error loading data:', error);
                console.log('Falling back to offline mode with sample data');
                loadOfflineData();
                // Ensure admin button is visible in error fallback
                document.getElementById('adminLink').style.display = 'inline-block';
            }
        }
        
        function loadOfflineData() {
            console.log('Loading offline sample data...');
            
            // Ensure admin user is set for offline mode
            if (!localStorage.getItem('currentUser')) {
                const defaultUser = {
                    name: 'Admin User',
                    email: 'admin@company.com',
                    role: 'admin'
                };
                localStorage.setItem('currentUser', JSON.stringify(defaultUser));
                console.log('Set default admin user for offline mode');
            }
            
            // Sample data for offline mode
            employees = [
                { id: 1, name: 'John Smith', department: 'Engineering', email: 'john@company.com' },
                { id: 2, name: 'Sarah Johnson', department: 'Marketing', email: 'sarah@company.com' },
                { id: 3, name: 'Mike Wilson', department: 'Engineering', email: 'mike@company.com' },
                { id: 4, name: 'Lisa Brown', department: 'Design', email: 'lisa@company.com' },
                { id: 5, name: 'David Lee', department: 'Marketing', email: 'david@company.com' }
            ];
            
            projects = [
                { id: 1, name: 'Project Alpha', type: 'project', description: 'Main development project' },
                { id: 2, name: 'Project Beta', type: 'project', description: 'Secondary project' },
                { id: 3, name: 'Marketing Campaign', type: 'presale', description: 'Q1 marketing initiative' },
                { id: 4, name: 'Design System', type: 'project', description: 'UI/UX design system' }
            ];
            
            efforts = [
                { id: 1, employeeId: 1, projectId: 1, week: 202501, effort: 4 },
                { id: 2, employeeId: 1, projectId: 2, week: 202501, effort: 1 },
                { id: 3, employeeId: 2, projectId: 3, week: 202501, effort: 3 },
                { id: 4, employeeId: 3, projectId: 1, week: 202501, effort: 5 },
                { id: 5, employeeId: 4, projectId: 4, week: 202501, effort: 4 },
                { id: 6, employeeId: 5, projectId: 3, week: 202501, effort: 2 }
            ];
            
            assignments = [
                { id: 1, employeeId: 1, projectId: 1 },
                { id: 2, employeeId: 1, projectId: 2 },
                { id: 3, employeeId: 2, projectId: 3 },
                { id: 4, employeeId: 3, projectId: 1 },
                { id: 5, employeeId: 4, projectId: 4 },
                { id: 6, employeeId: 5, projectId: 3 }
            ];
            
            console.log('✅ Offline data loaded:', {
                employees: employees.length,
                projects: projects.length,
                efforts: efforts.length,
                assignments: assignments.length
            });
            
            // Initialize the UI with offline data
            updateDepartmentFilter();
            updateEmployeeFilter();
            updateProjectFilter();
            calculateMetrics();
            updateBarChart();
            updatePieChart();
            renderDepartmentSummary();
            renderProjectSummary();
            renderEmployeeSummary();
            updateDetailFilters();
            updateProjectFilters();
            renderProjectWorkload();
            
            // Ensure admin button is visible in offline mode
            document.getElementById('adminLink').style.display = 'inline-block';
        }

        function updateDepartmentFilter() {
            const filter = document.getElementById('departmentFilter');
            const departments = [...new Set(employees.map(emp => emp.department))];
            
            filter.innerHTML = '<option value="">All Departments</option>' +
                departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        }

        function updateEmployeeFilter() {
            const filter = document.getElementById('employeeFilter');
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const assignedEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            filter.innerHTML = '<option value="">All Employees</option>' +
                assignedEmployees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.department})</option>`).join('');
        }
        
        function updateProjectFilter() {
            const filter = document.getElementById('projectFilter');
            filter.innerHTML = '<option value="">All Projects</option>' +
                projects.map(proj => `<option value="${proj.id}">${proj.name}</option>`).join('');
        }
        
        function filterData() {
            currentDepartment = document.getElementById('departmentFilter').value;
            currentPeriod = document.getElementById('periodFilter').value;
            currentEmployee = document.getElementById('employeeFilter').value;
            currentProject = document.getElementById('projectFilter').value;
            
            const weekSelector = document.getElementById('weekSelector');
            const monthSelector = document.getElementById('monthSelector');
            const yearSelector = document.getElementById('yearSelector');
            
            if (currentPeriod === 'week') {
                weekSelector.style.display = 'block';
                monthSelector.style.display = 'none';
                yearSelector.style.display = 'none';
                initializeWeekSelector();
            } else if (currentPeriod === 'month') {
                weekSelector.style.display = 'none';
                monthSelector.style.display = 'block';
                yearSelector.style.display = 'none';
                initializeMonthSelector();
            } else if (currentPeriod === 'year') {
                weekSelector.style.display = 'none';
                monthSelector.style.display = 'none';
                yearSelector.style.display = 'block';
            } else {
                weekSelector.style.display = 'none';
                monthSelector.style.display = 'none';
                yearSelector.style.display = 'none';
            }
            
            calculateMetrics();
            updateBarChart();
            updatePieChart();
            renderDepartmentSummary();
        }
        
        function initializeMonthSelector() {
            const startMonthInput = document.getElementById('startMonth');
            if (!startMonthInput.value) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                startMonthInput.value = `${year}-${month}`;
            }
        }
        
        function initializeWeekSelector() {
            const startWeekInput = document.getElementById('startWeek');
            if (!startWeekInput.value) {
                const now = new Date();
                const year = now.getFullYear();
                const weekNum = getWeekNumber(now);
                startWeekInput.value = `${year}-W${String(weekNum).padStart(2, '0')}`;
            }
        }

        function getFilteredEmployees() {
            if (assignments.length === 0) {
                console.log('No assignments found, showing all employees');
                let filteredEmployees = employees;
                if (currentDepartment) {
                    filteredEmployees = filteredEmployees.filter(emp => emp.department === currentDepartment);
                }
                return filteredEmployees;
            }
            
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            let filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            if (currentDepartment) {
                filteredEmployees = filteredEmployees.filter(emp => emp.department === currentDepartment);
            }
            
            return filteredEmployees;
        }

        function getEmployeeWorkload(employeeId) {
            const employeeAssignments = assignments.filter(a => a.employeeId === employeeId);
            let totalEffort = 0;
            const projectBreakdown = [];

            employeeAssignments.forEach(assignment => {
                let projectEfforts = efforts.filter(e => 
                    e.employeeId === employeeId && e.projectId === assignment.projectId
                );
                
                // Apply time period filter
                if (currentPeriod === 'month' && document.getElementById('startMonth').value) {
                    const [year, month] = document.getElementById('startMonth').value.split('-');
                    projectEfforts = projectEfforts.filter(e => {
                        // Handle both week formats: YYYYWW and simple week number
                        let weekYear, weekNum;
                        if (e.week > 1000) {
                            weekYear = Math.floor(e.week / 100);
                            weekNum = e.week % 100;
                        } else {
                            weekYear = new Date().getFullYear();
                            weekNum = e.week;
                        }
                        const weekDate = getDateFromWeek(weekYear, weekNum);
                        return weekDate.getFullYear() == year && weekDate.getMonth() + 1 == month;
                    });
                } else if (currentPeriod === 'week' && document.getElementById('startWeek').value) {
                    const [year, week] = document.getElementById('startWeek').value.split('-W');
                    const targetWeek = parseInt(week);
                    const targetYear = parseInt(year);
                    projectEfforts = projectEfforts.filter(e => {
                        if (e.week > 1000) {
                            return e.week === (targetYear * 100 + targetWeek);
                        } else {
                            return e.week === targetWeek;
                        }
                    });
                } else if (currentPeriod === 'year' && document.getElementById('yearSelect').value) {
                    const selectedYear = parseInt(document.getElementById('yearSelect').value);
                    projectEfforts = projectEfforts.filter(e => {
                        if (e.week > 1000) {
                            const weekYear = Math.floor(e.week / 100);
                            return weekYear === selectedYear;
                        } else {
                            return true; // For simple week format, include all
                        }
                    });
                }
                
                // Sum up effort values (parse string to number)
                const projectTotal = projectEfforts.reduce((sum, e) => sum + (parseFloat(e.effort) || 0), 0);
                totalEffort += projectTotal;
                
                const project = projects.find(p => p.id === assignment.projectId);
                if (project && projectTotal > 0) {
                    projectBreakdown.push({
                        name: project.name,
                        effort: projectTotal
                    });
                }
            });

            return { totalEffort, projectBreakdown };
        }
        
        function getDateFromWeek(year, week) {
            const firstDayOfYear = new Date(year, 0, 1);
            const daysToAdd = (week - 1) * 7;
            return new Date(firstDayOfYear.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
        }
        
        function getDateFromWeekString(year, week) {
            const firstDayOfYear = new Date(year, 0, 1);
            const daysToFirstMonday = (8 - firstDayOfYear.getDay()) % 7;
            const firstMonday = new Date(year, 0, 1 + daysToFirstMonday);
            return new Date(firstMonday.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
        }

        function getWorkingDaysInMonth(year, month) {
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            let workingDays = 0;
            
            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                    workingDays++;
                }
            }
            return workingDays;
        }
        
        function getWorkloadStatus(totalEffort) {
            let normalWorkload = 22; // default monthly workload
            
            if (currentPeriod === 'week') {
                normalWorkload = 5;
            } else if (currentPeriod === 'month' && document.getElementById('startMonth').value) {
                const [year, month] = document.getElementById('startMonth').value.split('-');
                normalWorkload = getWorkingDaysInMonth(parseInt(year), parseInt(month));
            } else if (currentPeriod === 'year' && document.getElementById('yearSelect').value) {
                const selectedYear = parseInt(document.getElementById('yearSelect').value);
                normalWorkload = getWorkingDaysInYear(selectedYear);
            }
            
            if (totalEffort > normalWorkload * 1.1) return 'overloaded'; // 10% tolerance
            if (totalEffort < normalWorkload * 0.8) return 'underutilized'; // 20% tolerance
            return 'normal';
        }
        
        function getWorkingDaysInYear(year) {
            let workingDays = 0;
            for (let month = 0; month < 12; month++) {
                workingDays += getWorkingDaysInMonth(year, month + 1);
            }
            return workingDays;
        }

        function calculateMetrics() {
            const filteredEmployees = getFilteredEmployees();
            let totalEmployees = filteredEmployees.length;
            let overloadedCount = 0;
            let underutilizedCount = 0;
            let totalEffort = 0;
            let activeProjects = new Set();

            console.log('Calculating metrics for', totalEmployees, 'employees');
            console.log('Efforts data:', efforts.slice(0, 3));
            console.log('Assignments data:', assignments.slice(0, 3));

            filteredEmployees.forEach(employee => {
                const workload = getEmployeeWorkload(employee.id);
                const status = getWorkloadStatus(workload.totalEffort);
                
                console.log(`Employee ${employee.name}: workload=${workload.totalEffort}, status=${status}`);
                
                totalEffort += workload.totalEffort;
                
                if (status === 'overloaded') overloadedCount++;
                if (status === 'underutilized') underutilizedCount++;
                
                workload.projectBreakdown.forEach(project => {
                    activeProjects.add(project.name);
                });
            });

            const avgWorkload = totalEmployees > 0 ? (totalEffort / totalEmployees).toFixed(1) : 0;

            let totalPaidDays = 0;
            let totalNonDays = 0;
            
            filteredEmployees.forEach(employee => {
                const workload = getEmployeeWorkload(employee.id);
                workload.projectBreakdown.forEach(project => {
                    const proj = projects.find(p => p.name === project.name);
                    if (!currentProject || proj.id == currentProject) {
                        if (proj && proj.type === 'presale') {
                            totalNonDays += project.effort;
                        } else {
                            totalPaidDays += project.effort;
                        }
                    }
                });
            });

            console.log('Final metrics:', {
                totalEmployees,
                overloadedCount,
                underutilizedCount,
                avgWorkload,
                activeProjects: activeProjects.size,
                totalPaidDays,
                totalNonDays
            });

            renderMetrics({
                totalEmployees,
                overloadedCount,
                underutilizedCount,
                avgWorkload,
                activeProjects: activeProjects.size,
                totalPaidDays,
                totalNonDays
            });
        }

        function renderMetrics(metrics) {
            const html = `
                <div class="metric-card">
                    <div class="metric-value">${metrics.totalEmployees}</div>
                    <div class="metric-label">Total Employees</div>
                </div>
                <div class="metric-card overloaded">
                    <div class="metric-value">${metrics.overloadedCount}</div>
                    <div class="metric-label">Overloaded</div>
                </div>
                <div class="metric-card underutilized">
                    <div class="metric-value">${metrics.underutilizedCount}</div>
                    <div class="metric-label">Underutilized</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.avgWorkload}d</div>
                    <div class="metric-label">Avg Workload</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.activeProjects}</div>
                    <div class="metric-label">Active Projects</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <div class="metric-value">${metrics.totalPaidDays}d</div>
                    <div class="metric-label">Paid Projects</div>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <div class="metric-value">${metrics.totalNonDays}d</div>
                    <div class="metric-label">Non Projects</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = html;
        }

        function renderDepartmentSummary() {
            const filteredEmployees = getFilteredEmployees();
            const departments = [...new Set(filteredEmployees.map(emp => emp.department))];
            
            const html = departments.map(dept => {
                const deptEmployees = filteredEmployees.filter(emp => emp.department === dept);
                let totalEffort = 0;
                let overloadedCount = 0;
                
                deptEmployees.forEach(emp => {
                    const workload = getEmployeeWorkload(emp.id);
                    totalEffort += workload.totalEffort;
                    if (getWorkloadStatus(workload.totalEffort) === 'overloaded') {
                        overloadedCount++;
                    }
                });
                
                const avgWorkload = deptEmployees.length > 0 ? (totalEffort / deptEmployees.length).toFixed(1) : 0;
                
                return `
                    <div class="dept-card">
                        <div class="dept-name">${dept}</div>
                        <div class="dept-stats">
                            <div class="dept-stat">
                                <div class="dept-stat-value">${deptEmployees.length}</div>
                                <div class="dept-stat-label">Employees</div>
                            </div>
                            <div class="dept-stat">
                                <div class="dept-stat-value">${avgWorkload}d</div>
                                <div class="dept-stat-label">Avg Load</div>
                            </div>
                            <div class="dept-stat">
                                <div class="dept-stat-value">${overloadedCount}</div>
                                <div class="dept-stat-label">Overloaded</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('departmentSummary').innerHTML = html || '<div class="empty-state">No departments found</div>';
        }

        function renderEmployeeSummary() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            let allEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            // Apply detail filters
            const detailDepartment = document.getElementById('detailDepartmentFilter').value;
            const detailEmployee = document.getElementById('detailEmployeeFilter').value;
            const detailProject = document.getElementById('detailProjectFilter').value;
            
            if (detailDepartment) {
                allEmployees = allEmployees.filter(emp => emp.department === detailDepartment);
            }
            if (detailEmployee) {
                allEmployees = allEmployees.filter(emp => emp.id == detailEmployee);
            }
            
            if (allEmployees.length === 0) {
                document.getElementById('employeeSummary').innerHTML = 
                    '<div style="text-align: center; color: #6b7280; padding: 40px;">No employees found with project assignments</div>';
                return;
            }
            
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter !== 'all') {
                allEmployees = allEmployees.filter(employee => {
                    const workload = getDetailEmployeeWorkload(employee.id);
                    const status = getDetailWorkloadStatus(workload.totalEffort);
                    return status === statusFilter;
                });
            }
            
            const sortedEmployees = allEmployees.sort((a, b) => {
                const workloadA = getDetailEmployeeWorkload(a.id).totalEffort;
                const workloadB = getDetailEmployeeWorkload(b.id).totalEffort;
                return workloadB - workloadA;
            });
            
            const viewType = document.getElementById('viewType').value;
            
            if (viewType === 'table') {
                renderEmployeeTable(sortedEmployees);
                return;
            }
            
            const html = sortedEmployees.map(employee => {
                const workload = getDetailEmployeeWorkload(employee.id);
                const status = getDetailWorkloadStatus(workload.totalEffort);
                
                const statusClass = `workload-${status}`;
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                const projectsHtml = workload.projectBreakdown.length > 0 
                    ? workload.projectBreakdown.map(project => `
                        <div class="project-item">
                            <span class="project-name">${project.name}</span>
                            <span class="project-effort">${project.effort}d</span>
                        </div>
                    `).join('')
                    : '<div class="project-item"><span class="project-name">No active projects</span></div>';
                
                return `
                    <div class="employee-card">
                        <div class="employee-header">
                            <div>
                                <div class="employee-name">${employee.name}</div>
                                <div class="employee-dept">${employee.department}</div>
                            </div>
                            <div class="workload-indicator ${statusClass}">
                                ${statusText}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #374151;">Total Workload:</span>
                            <span style="font-weight: 700; color: #1e3a8a; font-size: 18px;">${workload.totalEffort}d</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #374151;">Project Types:</span>
                            <span style="font-weight: 600; color: #6b7280; font-size: 14px;">${(() => {
                                let paidDays = 0, nonDays = 0;
                                workload.projectBreakdown.forEach(project => {
                                    const proj = projects.find(p => p.name === project.name);
                                    if (proj && proj.type === 'presale') nonDays += project.effort;
                                    else paidDays += project.effort;
                                });
                                return `Paid: ${paidDays}d, Non: ${nonDays}d`;
                            })()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #374151;">Working Days:</span>
                            <span style="font-weight: 600; color: #6b7280; font-size: 14px;">All Time</span>
                        </div>
                        <div class="project-list">
                            ${projectsHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('employeeSummary').innerHTML = html;
        }

        function getProjectColor(projectName) {
            if (projectColors[projectName]) {
                return projectColors[projectName];
            }
            const color = defaultColors[colorIndex % defaultColors.length];
            projectColors[projectName] = color;
            colorIndex++;
            return color;
        }
        
        function generateWeeks() {
            const weeks = [];
            
            if (currentPeriod === 'month' && document.getElementById('startMonth').value) {
                const [year, month] = document.getElementById('startMonth').value.split('-');
                const monthStart = new Date(parseInt(year), parseInt(month) - 1, 1);
                const monthEnd = new Date(parseInt(year), parseInt(month), 0);
                
                // Find the first Monday of the month or before
                let currentDate = new Date(monthStart);
                while (currentDate.getDay() !== 1) {
                    currentDate.setDate(currentDate.getDate() - 1);
                }
                
                const weekSet = new Set();
                while (currentDate <= monthEnd || (currentDate.getMonth() === parseInt(month) - 1 && currentDate.getDate() <= 7)) {
                    const weekNum = getWeekNumber(currentDate);
                    const weekValue = weekNum + (currentDate.getFullYear() * 100);
                    
                    if (!weekSet.has(weekValue)) {
                        weekSet.add(weekValue);
                        const weekOfMonth = Math.ceil(currentDate.getDate() / 7);
                        weeks.push({
                            label: `${currentDate.getFullYear()}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/W${weekOfMonth}`,
                            value: weekValue
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + 7);
                }
            } else if (currentPeriod === 'week' && document.getElementById('startWeek').value) {
                const [year, week] = document.getElementById('startWeek').value.split('-W');
                const weekValue = parseInt(week) + (parseInt(year) * 100);
                const weekDate = getDateFromWeekString(parseInt(year), parseInt(week));
                const weekOfMonth = Math.ceil(weekDate.getDate() / 7);
                weeks.push({
                    label: `${year}/${String(weekDate.getMonth() + 1).padStart(2, '0')}/W${weekOfMonth}`,
                    value: weekValue
                });
            } else if (currentPeriod === 'year' && document.getElementById('yearSelect').value) {
                const selectedYear = parseInt(document.getElementById('yearSelect').value);
                // Generate all weeks for the selected year
                for (let week = 1; week <= 52; week++) {
                    const weekValue = week + (selectedYear * 100);
                    const weekDate = getDateFromWeek(selectedYear, week);
                    const weekOfMonth = Math.ceil(weekDate.getDate() / 7);
                    weeks.push({
                        label: `${selectedYear}/${String(weekDate.getMonth() + 1).padStart(2, '0')}/W${weekOfMonth}`,
                        value: weekValue
                    });
                }
            } else {
                // Default: show current month weeks
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0);
                
                let currentDate = new Date(monthStart);
                while (currentDate.getDay() !== 1) {
                    currentDate.setDate(currentDate.getDate() - 1);
                }
                
                const weekSet = new Set();
                while (currentDate <= monthEnd || (currentDate.getMonth() === month && currentDate.getDate() <= 7)) {
                    const weekNum = getWeekNumber(currentDate);
                    const weekValue = weekNum + (currentDate.getFullYear() * 100);
                    
                    if (!weekSet.has(weekValue)) {
                        weekSet.add(weekValue);
                        const weekOfMonth = Math.ceil(currentDate.getDate() / 7);
                        weeks.push({
                            label: `${currentDate.getFullYear()}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/W${weekOfMonth}`,
                            value: weekValue
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + 7);
                }
            }
            
            console.log('Generated weeks:', weeks);
            return weeks;
        }
        
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        function updateChart() {
            const chartType = document.getElementById('chartType').value;
            const chartView = document.getElementById('chartView').value;
            const sortBy = document.getElementById('sortBy').value;
            
            const barChart = document.getElementById('workloadChart');
            const pieChart = document.getElementById('pieChart');
            const viewControl = document.getElementById('viewControl');
            
            const sortControl = document.getElementById('sortControl');
            const pieViewControl = document.getElementById('pieViewControl');
            
            if (chartType === 'pie') {
                barChart.style.display = 'none';
                pieChart.style.display = 'flex';
                viewControl.style.display = 'none';
                sortControl.style.display = 'none';
                pieViewControl.style.display = 'block';
                renderPieChart();
            } else {
                barChart.style.display = 'flex';
                pieChart.style.display = 'none';
                viewControl.style.display = 'block';
                sortControl.style.display = 'block';
                pieViewControl.style.display = 'none';
                
                if (chartView === 'employee') {
                    renderEmployeeChart(sortBy);
                } else {
                    renderWeekChart();
                }
            }
        }
        
        function renderEmployeeChart(sortBy) {
            try {
                console.log('📊 Rendering employee chart...');
                let filteredEmployees = getFilteredEmployees();
                console.log('Filtered employees:', filteredEmployees.length);
                
                if (currentEmployee) {
                    filteredEmployees = filteredEmployees.filter(emp => emp.id == currentEmployee);
                }
                
                if (filteredEmployees.length === 0) {
                    document.getElementById('workloadChart').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No employees match current filters</div>';
                    return;
                }
                
                const employeeData = filteredEmployees.map(employee => {
                    const workload = getEmployeeWorkload(employee.id);
                    let projectBreakdown = workload.projectBreakdown;
                    
                    if (currentProject) {
                        projectBreakdown = projectBreakdown.filter(p => {
                            const project = projects.find(proj => proj.name === p.name);
                            return project && project.id == currentProject;
                        });
                    }
                    
                    return {
                        employee,
                        totalEffort: projectBreakdown.reduce((sum, p) => sum + p.effort, 0),
                        projects: projectBreakdown
                    };
                });
                
                console.log('Employee data for chart:', employeeData.map(d => ({name: d.employee.name, effort: d.totalEffort})));
                
                if (employeeData.every(d => d.totalEffort === 0)) {
                    document.getElementById('workloadChart').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No workload data found for selected period</div>';
                    return;
                }
                
                if (employeeData.length > 0) {
                    employeeData.sort((a, b) => {
                        if (sortBy === 'workload') return b.totalEffort - a.totalEffort;
                        if (sortBy === 'name') return a.employee.name.localeCompare(b.employee.name);
                        if (sortBy === 'department') return a.employee.department.localeCompare(b.employee.department);
                        return 0;
                    });
                }
                
                const maxEffort = Math.max(...employeeData.map(d => d.totalEffort)) || 1;
                
                const chartHtml = employeeData.map(data => {
                    const barHeight = data.totalEffort === 0 ? 0 : Math.max(5, (data.totalEffort / maxEffort) * 300);
                    
                    const segments = data.projects.map(project => {
                        const segmentHeight = data.totalEffort > 0 ? (project.effort / data.totalEffort) * barHeight : 0;
                        const color = getProjectColor(project.name);
                        
                        return `<div class="bar-segment" 
                            style="height: ${segmentHeight}px; background-color: ${color};" 
                            onmouseover="showTooltip(event, '${project.name}: ${project.effort}d')" 
                            onmouseout="hideTooltip()"></div>`;
                    }).join('');
                    
                    return `
                        <div class="bar-group">
                            <div class="bar" style="height: ${barHeight}px;">
                                ${segments}
                            </div>
                            <div class="bar-value">${data.totalEffort}d</div>
                            <div class="bar-label">${data.employee.name}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('workloadChart').innerHTML = chartHtml;
                renderLegend(employeeData);
                console.log('✅ Employee chart rendered successfully');
            } catch (error) {
                console.error('❌ Error rendering employee chart:', error);
                document.getElementById('workloadChart').innerHTML = `<div style="text-align: center; color: #ef4444; padding: 40px;">Chart error: ${error.message}</div>`;
            }
        }
        
        function renderWeekChart() {
            try {
                console.log('📊 Rendering week chart...');
                const weeks = generateWeeks();
                let filteredEmployees = getFilteredEmployees();
                
                console.log('Generated weeks:', weeks.length);
                console.log('Sample week:', weeks[0]);
                
                if (currentEmployee) {
                    filteredEmployees = filteredEmployees.filter(emp => emp.id == currentEmployee);
                }
                
                if (weeks.length === 0) {
                    document.getElementById('workloadChart').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No weeks generated for selected period</div>';
                    return;
                }
                
                const weekData = weeks.map(week => {
                    const weekEfforts = {};
                    let totalWeekEffort = 0;
                    
                    filteredEmployees.forEach(employee => {
                        const employeeAssignments = assignments.filter(a => a.employeeId === employee.id);
                        
                        employeeAssignments.forEach(assignment => {
                            // Find efforts that match this week - handle different week formats
                            const matchingEfforts = efforts.filter(e => {
                                if (e.employeeId !== employee.id || e.projectId !== assignment.projectId) {
                                    return false;
                                }
                                
                                // Handle both YYYYWW format and simple week numbers
                                let effortWeekValue;
                                if (e.week > 1000) {
                                    effortWeekValue = e.week; // Already in YYYYWW format
                                } else {
                                    // Convert simple week to YYYYWW format
                                    const currentYear = new Date().getFullYear();
                                    effortWeekValue = currentYear * 100 + e.week;
                                }
                                
                                return effortWeekValue === week.value;
                            });
                            
                            matchingEfforts.forEach(effort => {
                                if (effort.effort > 0) {
                                    const project = projects.find(p => p.id === assignment.projectId);
                                    if (project && (!currentProject || project.id == currentProject)) {
                                        if (!weekEfforts[project.name]) {
                                            weekEfforts[project.name] = 0;
                                        }
                                        weekEfforts[project.name] += parseFloat(effort.effort) || 0;
                                        totalWeekEffort += parseFloat(effort.effort) || 0;
                                    }
                                }
                            });
                        });
                    });
                    
                    return {
                        week,
                        efforts: weekEfforts,
                        total: totalWeekEffort
                    };
                });
                
                console.log('Week data processed:', weekData.map(d => ({label: d.week.label, total: d.total})));
                
                if (weekData.every(d => d.total === 0)) {
                    document.getElementById('workloadChart').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No workload data found for selected weeks</div>';
                    return;
                }
                
                const maxEffort = Math.max(...weekData.map(d => d.total), 1);
                
                const chartHtml = weekData.map(data => {
                    const barHeight = data.total === 0 ? 0 : Math.max(5, (data.total / maxEffort) * 300);
                    
                    const segments = Object.entries(data.efforts).map(([projectName, effort]) => {
                        const segmentHeight = data.total > 0 ? (effort / data.total) * barHeight : 0;
                        const color = getProjectColor(projectName);
                        
                        return `<div class="bar-segment" 
                            style="height: ${segmentHeight}px; background-color: ${color};" 
                            onmouseover="showTooltip(event, '${projectName}: ${effort}d')" 
                            onmouseout="hideTooltip()"></div>`;
                    }).join('');
                    
                    return `
                        <div class="bar-group">
                            <div class="bar" style="height: ${barHeight}px;">
                                ${segments}
                            </div>
                            <div class="bar-value">${data.total}d</div>
                            <div class="bar-label">${data.week.label}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('workloadChart').innerHTML = chartHtml;
                renderLegend(weekData);
                console.log('✅ Week chart rendered successfully');
            } catch (error) {
                console.error('❌ Error rendering week chart:', error);
                document.getElementById('workloadChart').innerHTML = `<div style="text-align: center; color: #ef4444; padding: 40px;">Chart error: ${error.message}</div>`;
            }
        }
        
        function renderLegend(data) {
            const allProjects = new Set();
            
            if (Array.isArray(data) && data.length > 0) {
                if (data[0].projects) {
                    data.forEach(d => d.projects.forEach(p => allProjects.add(p.name)));
                } else if (data[0].efforts) {
                    data.forEach(d => Object.keys(d.efforts).forEach(p => allProjects.add(p)));
                }
            }
            
            const legendHtml = Array.from(allProjects).map(projectName => {
                const color = getProjectColor(projectName);
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${color};"></div>
                        <span>${projectName}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('chartLegend').innerHTML = legendHtml;
        }
        
        function showTooltip(event, text) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = text;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.style.display = 'block';
            document.body.appendChild(tooltip);
        }
        
        function hideTooltip() {
            const tooltips = document.querySelectorAll('.tooltip');
            tooltips.forEach(tooltip => tooltip.remove());
        }
        
        function renderPieChart() {
            const pieView = document.getElementById('pieView').value;
            let chartData = [];
            
            if (pieView === 'employee') {
                let filteredEmployees = getFilteredEmployees();
                if (currentEmployee) {
                    filteredEmployees = filteredEmployees.filter(emp => emp.id == currentEmployee);
                }
                
                chartData = filteredEmployees.map(employee => {
                    const workload = getEmployeeWorkload(employee.id);
                    let totalValue = workload.totalEffort;
                    if (currentProject) {
                        totalValue = workload.projectBreakdown
                            .filter(p => {
                                const proj = projects.find(pr => pr.name === p.name);
                                return proj && proj.id == currentProject;
                            })
                            .reduce((sum, p) => sum + p.effort, 0);
                    }
                    return {
                        name: employee.name,
                        value: totalValue
                    };
                }).filter(d => d.value > 0);
                
            } else if (pieView === 'project') {
                const projectTotals = {};
                const filteredEmployees = getFilteredEmployees();
                
                filteredEmployees.forEach(employee => {
                    const workload = getEmployeeWorkload(employee.id);
                    workload.projectBreakdown.forEach(project => {
                        if (!projectTotals[project.name]) {
                            projectTotals[project.name] = 0;
                        }
                        projectTotals[project.name] += project.effort;
                    });
                });
                
                chartData = Object.entries(projectTotals).map(([name, value]) => ({ name, value }));
                
            } else if (pieView === 'department') {
                const deptTotals = {};
                const filteredEmployees = getFilteredEmployees();
                
                filteredEmployees.forEach(employee => {
                    const workload = getEmployeeWorkload(employee.id);
                    if (!deptTotals[employee.department]) {
                        deptTotals[employee.department] = 0;
                    }
                    deptTotals[employee.department] += workload.totalEffort;
                });
                
                chartData = Object.entries(deptTotals).map(([name, value]) => ({ name, value }));
                
            } else if (pieView === 'projecttype') {
                const typeTotals = { 'Paid Project': 0, 'Non Project': 0 };
                let filteredEmployees = getFilteredEmployees();
                
                if (currentEmployee) {
                    filteredEmployees = filteredEmployees.filter(emp => emp.id == currentEmployee);
                }
                
                filteredEmployees.forEach(employee => {
                    const workload = getEmployeeWorkload(employee.id);
                    workload.projectBreakdown.forEach(projectData => {
                        const project = projects.find(p => p.name === projectData.name);
                        if (!currentProject || project.id == currentProject) {
                            const projectType = project && project.type === 'presale' ? 'Non Project' : 'Paid Project';
                            typeTotals[projectType] += projectData.effort;
                        }
                    });
                });
                
                chartData = Object.entries(typeTotals).filter(([name, value]) => value > 0).map(([name, value]) => ({ name, value }));
            }
            
            chartData.sort((a, b) => b.value - a.value);
            
            if (chartData.length > 10) {
                const top10 = chartData.slice(0, 10);
                const othersValue = chartData.slice(10).reduce((sum, d) => sum + d.value, 0);
                if (othersValue > 0) {
                    top10.push({ name: 'Others', value: othersValue });
                }
                chartData = top10;
            }
            
            const total = chartData.reduce((sum, d) => sum + d.value, 0);
            if (total === 0) {
                document.getElementById('pieSvg').innerHTML = '<text x="200" y="200" text-anchor="middle" fill="#6b7280">No data available</text>';
                return;
            }
            
            const svg = document.getElementById('pieSvg');
            const centerX = 200;
            const centerY = 200;
            const radius = 150;
            
            let currentAngle = 0;
            let svgContent = '';
            
            chartData.forEach((data, index) => {
                const percentage = (data.value / total) * 100;
                const angle = (data.value / total) * 2 * Math.PI;
                
                const x1 = centerX + radius * Math.cos(currentAngle);
                const y1 = centerY + radius * Math.sin(currentAngle);
                const x2 = centerX + radius * Math.cos(currentAngle + angle);
                const y2 = centerY + radius * Math.sin(currentAngle + angle);
                
                const largeArcFlag = angle > Math.PI ? 1 : 0;
                const color = pieView === 'projecttype' ? 
                    (data.name === 'Paid Project' ? '#10b981' : '#f59e0b') : 
                    getProjectColor(pieView === 'projecttype' ? data.name : `${pieView}-${index}`);
                
                const pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                
                svgContent += `<path d="${pathData}" fill="${color}" class="pie-slice" onmouseover="showTooltip(event, '${data.name}: ${data.value}d (${percentage.toFixed(1)}%)')" onmouseout="hideTooltip()"></path>`;
                
                currentAngle += angle;
            });
            
            svg.innerHTML = svgContent;
            renderPieLegend(chartData.map(d => ({ name: d.name })));
        }
        
        function renderPieLegend(data) {
            const allProjects = new Set();
            data.forEach(d => allProjects.add(d.name));
            
            const pieView = document.getElementById('pieView').value;
            const legendHtml = Array.from(allProjects).map((name, index) => {
                let color;
                if (pieView === 'projecttype') {
                    color = name === 'Paid Project' ? '#10b981' : '#f59e0b';
                } else {
                    color = getProjectColor(`${pieView}-${index}`);
                }
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: ${color};"></div>
                        <span>${name}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('pieLegend').innerHTML = legendHtml;
        }
        
        function updateChart() {
            updateBarChart();
            updatePieChart();
        }
        
        function updateBarChart() {
            const chartView = document.getElementById('chartView').value;
            const sortBy = document.getElementById('sortBy').value;
            
            if (chartView === 'employee') {
                renderEmployeeChart(sortBy);
            } else {
                renderWeekChart();
            }
        }
        
        function updatePieChart() {
            renderPieChart();
        }
        
        function filterEmployeesByStatus() {
            renderEmployeeSummary();
        }
        
        function renderEmployeeTable(employees) {
            if (employees.length === 0) {
                document.getElementById('employeeSummary').innerHTML = 
                    '<div style="text-align: center; color: #6b7280; padding: 40px;">No employees found</div>';
                return;
            }
            
            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #1e3a8a; color: white;">
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Employee</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Department</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Total Workload</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Working Days</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Status</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Projects</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            employees.forEach((employee, index) => {
                const workload = getDetailEmployeeWorkload(employee.id);
                const status = getDetailWorkloadStatus(workload.totalEffort);
                const statusClass = `workload-${status}`;
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                const projectsText = workload.projectBreakdown.length > 0 
                    ? workload.projectBreakdown.map(p => `${p.name} (${p.effort}d)`).join(', ')
                    : 'No active projects';
                
                const rowStyle = index % 2 === 0 ? 'background: #f8fafc;' : 'background: white;';
                
                tableHtml += `
                    <tr style="${rowStyle} border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; font-weight: 600; color: #1e3a8a;">${employee.name}</td>
                        <td style="padding: 12px; color: #6b7280;">${employee.department}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; color: #1e3a8a;">${workload.totalEffort}d</td>
                        <td style="padding: 12px; text-align: center; color: #6b7280;">All Time</td>
                        <td style="padding: 12px; text-align: center;">
                            <span class="workload-indicator ${statusClass}" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                ${statusText}
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #374151;">
                            ${(() => {
                                let paidDays = 0, nonDays = 0;
                                workload.projectBreakdown.forEach(project => {
                                    const proj = projects.find(p => p.name === project.name);
                                    if (proj && proj.type === 'presale') nonDays += project.effort;
                                    else paidDays += project.effort;
                                });
                                return `<div style="margin-bottom: 4px;"><strong>Paid:</strong> ${paidDays}d, <strong>Non:</strong> ${nonDays}d</div><div>${projectsText}</div>`;
                            })()} 
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            document.getElementById('employeeSummary').innerHTML = tableHtml;
        }
        
        function downloadExcel() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            let allEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            // Apply detail filters
            const detailDepartment = document.getElementById('detailDepartmentFilter').value;
            const detailEmployee = document.getElementById('detailEmployeeFilter').value;
            
            if (detailDepartment) {
                allEmployees = allEmployees.filter(emp => emp.department === detailDepartment);
            }
            if (detailEmployee) {
                allEmployees = allEmployees.filter(emp => emp.id == detailEmployee);
            }
            
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter !== 'all') {
                allEmployees = allEmployees.filter(employee => {
                    const workload = getDetailEmployeeWorkload(employee.id);
                    const status = getDetailWorkloadStatus(workload.totalEffort);
                    return status === statusFilter;
                });
            }
            
            const sortedEmployees = allEmployees.sort((a, b) => {
                const workloadA = getDetailEmployeeWorkload(a.id).totalEffort;
                const workloadB = getDetailEmployeeWorkload(b.id).totalEffort;
                return workloadB - workloadA;
            });
            
            const detailPeriod = document.getElementById('detailPeriodFilter').value;
            const periodText = detailPeriod === 'all' ? 'All Time' : detailPeriod;
            
            let csvContent = 'Employee,Department,Total Workload,Working Days,Status,Project Types,Projects\n';
            
            sortedEmployees.forEach(employee => {
                const workload = getDetailEmployeeWorkload(employee.id);
                const status = getDetailWorkloadStatus(workload.totalEffort);
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                const projectsText = workload.projectBreakdown.length > 0 
                    ? workload.projectBreakdown.map(p => `${p.name} (${p.effort}d)`).join('; ')
                    : 'No active projects';
                
                let paidDays = 0, nonDays = 0;
                workload.projectBreakdown.forEach(project => {
                    const proj = projects.find(p => p.name === project.name);
                    if (proj && proj.type === 'presale') nonDays += project.effort;
                    else paidDays += project.effort;
                });
                
                csvContent += `"${employee.name}","${employee.department}","${workload.totalEffort}d","${periodText}","${statusText}","Paid: ${paidDays}d, Non: ${nonDays}d","${projectsText}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'employee_workload_summary.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderProjectSummary() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const allEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            const projectTotals = {};
            
            allEmployees.forEach(employee => {
                const employeeAssignments = assignments.filter(a => a.employeeId === employee.id);
                employeeAssignments.forEach(assignment => {
                    const projectEfforts = efforts.filter(e => e.employeeId === employee.id && e.projectId === assignment.projectId);
                    const projectTotal = projectEfforts.reduce((sum, e) => sum + (parseFloat(e.effort) || 0), 0);
                    
                    if (projectTotal > 0) {
                        const project = projects.find(p => p.id === assignment.projectId);
                        if (project) {
                            if (!projectTotals[project.name]) {
                                projectTotals[project.name] = {
                                    name: project.name,
                                    totalEffort: 0,
                                    type: project.type || 'project',
                                    employees: new Set()
                                };
                            }
                            projectTotals[project.name].totalEffort += projectTotal;
                            projectTotals[project.name].employees.add(employee.name);
                        }
                    }
                });
            });
            
            const sortedProjects = Object.values(projectTotals).sort((a, b) => b.totalEffort - a.totalEffort);
            const viewType = document.getElementById('projectViewType').value;
            
            if (viewType === 'table') {
                renderProjectTable(sortedProjects);
            } else {
                renderProjectCards(sortedProjects);
            }
        }
        
        function renderProjectTable(projects) {
            if (projects.length === 0) {
                document.getElementById('projectSummary').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No projects found</div>';
                return;
            }
            
            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #1e3a8a; color: white;">
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Project</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Type</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Total Workload</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Employees</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            projects.forEach((project, index) => {
                const rowStyle = index % 2 === 0 ? 'background: #f8fafc;' : 'background: white;';
                const typeText = project.type === 'presale' ? 'Non Project' : 'Paid Project';
                const typeColor = project.type === 'presale' ? '#f59e0b' : '#10b981';
                
                tableHtml += `
                    <tr style="${rowStyle} border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; font-weight: 600; color: #1e3a8a;">${project.name}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${typeText}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; color: #1e3a8a;">${project.totalEffort}d</td>
                        <td style="padding: 12px; text-align: center; color: #6b7280;">${project.employees.size}</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            document.getElementById('projectSummary').innerHTML = tableHtml;
        }
        
        function renderProjectCards(projects) {
            if (projects.length === 0) {
                document.getElementById('projectSummary').innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No projects found</div>';
                return;
            }
            
            const html = projects.map(project => {
                const typeText = project.type === 'presale' ? 'Non Project' : 'Paid Project';
                const typeColor = project.type === 'presale' ? '#f59e0b' : '#10b981';
                
                return `
                    <div class="employee-card">
                        <div class="employee-header">
                            <div>
                                <div class="employee-name">${project.name}</div>
                            </div>
                            <div style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${typeText}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #374151;">Total Workload:</span>
                            <span style="font-weight: 700; color: #1e3a8a; font-size: 18px;">${project.totalEffort}d</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: #374151;">Employees:</span>
                            <span style="font-weight: 600; color: #6b7280;">${project.employees.size}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('projectSummary').innerHTML = html;
        }
        
        function downloadProjectExcel() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const allEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            const projectTotals = {};
            
            allEmployees.forEach(employee => {
                const employeeAssignments = assignments.filter(a => a.employeeId === employee.id);
                employeeAssignments.forEach(assignment => {
                    const projectEfforts = efforts.filter(e => e.employeeId === employee.id && e.projectId === assignment.projectId);
                    // Sum up days instead of effort percentage
                    const projectTotal = projectEfforts.reduce((sum, e) => {
                        const days = e.days || (e.effort > 0 ? Math.round((e.effort / 100) * 5) : 0);
                        return sum + days;
                    }, 0);
                    
                    if (projectTotal > 0) {
                        const project = projects.find(p => p.id === assignment.projectId);
                        if (project) {
                            if (!projectTotals[project.name]) {
                                projectTotals[project.name] = {
                                    name: project.name,
                                    totalEffort: 0,
                                    type: project.type || 'project',
                                    employees: new Set()
                                };
                            }
                            projectTotals[project.name].totalEffort += projectTotal;
                            projectTotals[project.name].employees.add(employee.name);
                        }
                    }
                });
            });
            
            const sortedProjects = Object.values(projectTotals).sort((a, b) => b.totalEffort - a.totalEffort);
            
            let csvContent = 'Project,Type,Total Workload,Employees\n';
            
            sortedProjects.forEach(project => {
                const typeText = project.type === 'presale' ? 'Non Project' : 'Paid Project';
                csvContent += `"${project.name}","${typeText}","${project.totalEffort}d","${project.employees.size}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'project_workload_summary.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function setCurrentWeek() {
            const now = new Date();
            const year = now.getFullYear();
            const weekNum = getWeekNumber(now);
            document.getElementById('startWeek').value = `${year}-W${String(weekNum).padStart(2, '0')}`;
            filterData();
        }
        
        function setCurrentMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('startMonth').value = `${year}-${month}`;
            filterData();
        }
        
        function setCurrentYear() {
            const now = new Date();
            document.getElementById('yearSelect').value = now.getFullYear().toString();
            filterData();
        }
        
        function getDetailEmployeeWorkload(employeeId) {
            const detailPeriod = document.getElementById('detailPeriodFilter').value;
            const detailProject = document.getElementById('detailProjectFilter').value;
            
            const employeeAssignments = assignments.filter(a => a.employeeId === employeeId);
            let totalEffort = 0;
            const projectBreakdown = [];

            employeeAssignments.forEach(assignment => {
                let projectEfforts = efforts.filter(e => e.employeeId === employeeId && e.projectId === assignment.projectId);
                
                // Apply time period filter
                if (detailPeriod === 'month' && document.getElementById('detailStartMonth').value) {
                    const [year, month] = document.getElementById('detailStartMonth').value.split('-');
                    projectEfforts = projectEfforts.filter(e => {
                        let weekYear, weekNum;
                        if (e.week > 1000) {
                            weekYear = Math.floor(e.week / 100);
                            weekNum = e.week % 100;
                        } else {
                            weekYear = new Date().getFullYear();
                            weekNum = e.week;
                        }
                        const weekDate = getDateFromWeek(weekYear, weekNum);
                        return weekDate.getFullYear() == year && weekDate.getMonth() + 1 == month;
                    });
                } else if (detailPeriod === 'week' && document.getElementById('detailStartWeek').value) {
                    const [year, week] = document.getElementById('detailStartWeek').value.split('-W');
                    const targetWeek = parseInt(week);
                    const targetYear = parseInt(year);
                    projectEfforts = projectEfforts.filter(e => {
                        if (e.week > 1000) {
                            return e.week === (targetYear * 100 + targetWeek);
                        } else {
                            return e.week === targetWeek;
                        }
                    });
                } else if (detailPeriod === 'year' && document.getElementById('detailYearSelect').value) {
                    const selectedYear = parseInt(document.getElementById('detailYearSelect').value);
                    projectEfforts = projectEfforts.filter(e => {
                        if (e.week > 1000) {
                            const weekYear = Math.floor(e.week / 100);
                            return weekYear === selectedYear;
                        } else {
                            return true;
                        }
                    });
                }
                
                // Sum up effort values (parse string to number)
                const projectTotal = projectEfforts.reduce((sum, e) => sum + (parseFloat(e.effort) || 0), 0);
                
                const project = projects.find(p => p.id === assignment.projectId);
                if (project && projectTotal > 0) {
                    // Apply project filter
                    if (!detailProject || project.id == detailProject) {
                        totalEffort += projectTotal;
                        projectBreakdown.push({
                            name: project.name,
                            effort: projectTotal
                        });
                    }
                }
            });

            return { totalEffort, projectBreakdown };
        }
        
        function getDetailWorkloadStatus(totalEffort) {
            const detailPeriod = document.getElementById('detailPeriodFilter').value;
            let normalWorkload = 22;
            
            if (detailPeriod === 'month' && document.getElementById('detailStartMonth').value) {
                const [year, month] = document.getElementById('detailStartMonth').value.split('-');
                normalWorkload = getWorkingDaysInMonth(parseInt(year), parseInt(month));
            } else if (detailPeriod === 'week') {
                normalWorkload = 5;
            } else if (detailPeriod === 'year' && document.getElementById('detailYearSelect').value) {
                const selectedYear = parseInt(document.getElementById('detailYearSelect').value);
                normalWorkload = getWorkingDaysInYear(selectedYear);
            }
            
            if (totalEffort > normalWorkload) return 'overloaded';
            if (totalEffort < normalWorkload) return 'underutilized';
            return 'normal';
        }
        
        function filterEmployeesByStatus() {
            const detailPeriod = document.getElementById('detailPeriodFilter').value;
            const detailMonthSelector = document.getElementById('detailMonthSelector');
            const detailWeekSelector = document.getElementById('detailWeekSelector');
            const detailYearSelector = document.getElementById('detailYearSelector');
            
            if (detailPeriod === 'week') {
                detailWeekSelector.style.display = 'block';
                detailMonthSelector.style.display = 'none';
                detailYearSelector.style.display = 'none';
            } else if (detailPeriod === 'month') {
                detailWeekSelector.style.display = 'none';
                detailMonthSelector.style.display = 'block';
                detailYearSelector.style.display = 'none';
            } else if (detailPeriod === 'year') {
                detailWeekSelector.style.display = 'none';
                detailMonthSelector.style.display = 'none';
                detailYearSelector.style.display = 'block';
            } else {
                detailWeekSelector.style.display = 'none';
                detailMonthSelector.style.display = 'none';
                detailYearSelector.style.display = 'none';
            }
            
            renderEmployeeSummary();
        }
        
        function updateDetailFilters() {
            // Update department filter
            const detailDeptFilter = document.getElementById('detailDepartmentFilter');
            const departments = [...new Set(employees.map(emp => emp.department))];
            detailDeptFilter.innerHTML = '<option value="">All Departments</option>' +
                departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
            
            // Update employee filter
            const detailEmpFilter = document.getElementById('detailEmployeeFilter');
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const assignedEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            detailEmpFilter.innerHTML = '<option value="">All Employees</option>' +
                assignedEmployees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.department})</option>`).join('');
            
            // Update project filter
            const detailProjFilter = document.getElementById('detailProjectFilter');
            detailProjFilter.innerHTML = '<option value="">All Projects</option>' +
                projects.map(proj => `<option value="${proj.id}">${proj.name}</option>`).join('');
        }
        
        function renderProjectWorkload() {
            const projectPeriod = document.getElementById('projectPeriodFilter').value;
            const projectMonthSelector = document.getElementById('projectMonthSelector');
            const projectWeekSelector = document.getElementById('projectWeekSelector');
            const projectYearSelector = document.getElementById('projectYearSelector');
            
            if (projectPeriod === 'week') {
                projectWeekSelector.style.display = 'block';
                projectMonthSelector.style.display = 'none';
                projectYearSelector.style.display = 'none';
            } else if (projectPeriod === 'month') {
                projectWeekSelector.style.display = 'none';
                projectMonthSelector.style.display = 'block';
                projectYearSelector.style.display = 'none';
            } else if (projectPeriod === 'year') {
                projectWeekSelector.style.display = 'none';
                projectMonthSelector.style.display = 'none';
                projectYearSelector.style.display = 'block';
            } else {
                projectWeekSelector.style.display = 'none';
                projectMonthSelector.style.display = 'none';
                projectYearSelector.style.display = 'none';
            }
            
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            let filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            // Apply filters
            const projectDepartment = document.getElementById('projectDepartmentFilter').value;
            const projectEmployee = document.getElementById('projectEmployeeFilter').value;
            const projectProject = document.getElementById('projectProjectFilter').value;
            const projectStatus = document.getElementById('projectStatusFilter').value;
            
            if (projectDepartment) {
                filteredEmployees = filteredEmployees.filter(emp => emp.department === projectDepartment);
            }
            if (projectEmployee) {
                filteredEmployees = filteredEmployees.filter(emp => emp.id == projectEmployee);
            }
            
            const projectWorkloadData = [];
            
            filteredEmployees.forEach(employee => {
                const employeeAssignments = assignments.filter(a => a.employeeId === employee.id);
                
                employeeAssignments.forEach(assignment => {
                    const project = projects.find(p => p.id === assignment.projectId);
                    if (!project || (projectProject && project.id != projectProject)) return;
                    
                    let projectEfforts = efforts.filter(e => e.employeeId === employee.id && e.projectId === assignment.projectId);
                    
                    // Apply time period filter
                    if (projectPeriod === 'month' && document.getElementById('projectStartMonth').value) {
                        const [year, month] = document.getElementById('projectStartMonth').value.split('-');
                        projectEfforts = projectEfforts.filter(e => {
                            const weekYear = Math.floor(e.week / 100);
                            const weekNum = e.week % 100;
                            const weekDate = getDateFromWeek(weekYear, weekNum);
                            return weekDate.getFullYear() == year && weekDate.getMonth() + 1 == month;
                        });
                    } else if (projectPeriod === 'week' && document.getElementById('projectStartWeek').value) {
                        const [year, week] = document.getElementById('projectStartWeek').value.split('-W');
                        const targetWeek = parseInt(week) + (parseInt(year) * 100);
                        projectEfforts = projectEfforts.filter(e => e.week === targetWeek);
                    } else if (projectPeriod === 'year' && document.getElementById('projectYearSelect').value) {
                        const selectedYear = parseInt(document.getElementById('projectYearSelect').value);
                        projectEfforts = projectEfforts.filter(e => {
                            const weekYear = Math.floor(e.week / 100);
                            return weekYear === selectedYear;
                        });
                    }
                    
                    const totalEffort = projectEfforts.reduce((sum, e) => sum + (parseFloat(e.effort) || 0), 0);
                    
                    if (totalEffort > 0) {
                        // Apply status filter
                        if (projectStatus !== 'all') {
                            const empWorkload = getProjectEmployeeWorkload(employee.id);
                            const empStatus = getProjectWorkloadStatus(empWorkload.totalEffort);
                            if (empStatus !== projectStatus) return;
                        }
                        
                        const weekDetails = projectEfforts.map(e => {
                            let weekYear, weekNum;
                            if (e.week > 1000) {
                                weekYear = Math.floor(e.week / 100);
                                weekNum = e.week % 100;
                            } else {
                                weekYear = new Date().getFullYear();
                                weekNum = e.week;
                            }
                            const weekDate = getDateFromWeek(weekYear, weekNum);
                            const weekOfMonth = Math.ceil(weekDate.getDate() / 7);
                            return {
                                week: `${weekYear}/${String(weekDate.getMonth() + 1).padStart(2, '0')}/W${weekOfMonth}`,
                                effort: e.effort || 0
                            };
                        });
                        
                        projectWorkloadData.push({
                            employee: employee.name,
                            department: employee.department,
                            project: project.name,
                            projectType: project.type === 'presale' ? 'Non Project' : 'Paid Project',
                            totalEffort,
                            weekDetails
                        });
                    }
                });
            });
            
            projectWorkloadGlobalData = projectWorkloadData;
            renderProjectWorkloadTable(projectWorkloadData);
        }
        
        function renderProjectWorkloadTable(data) {
            if (data.length === 0) {
                document.getElementById('projectWorkloadTable').innerHTML = 
                    '<div style="text-align: center; color: #6b7280; padding: 40px;">No project workload data found</div>';
                return;
            }
            
            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #1e3a8a; color: white;">
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Employee</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Department</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600;">Project</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Type</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Total Workload</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Status</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600;">Drill Down</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach((item, index) => {
                const rowStyle = index % 2 === 0 ? 'background: #f8fafc;' : 'background: white;';
                const typeColor = item.projectType === 'Non Project' ? '#f59e0b' : '#10b981';
                
                tableHtml += `
                    <tr style="${rowStyle} border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; font-weight: 600; color: #1e3a8a;">${item.employee}</td>
                        <td style="padding: 12px; color: #6b7280;">${item.department}</td>
                        <td style="padding: 12px; color: #374151;">${item.project}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${item.projectType}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; color: #1e3a8a;">${item.totalEffort}d</td>
                        <td style="padding: 12px; text-align: center;">
                            <span class="workload-indicator ${(() => {
                                const empWorkload = getProjectEmployeeWorkload(employees.find(e => e.name === item.employee).id);
                                const status = getProjectWorkloadStatus(empWorkload.totalEffort);
                                return `workload-${status}`;
                            })()} " style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                ${(() => {
                                    const empWorkload = getProjectEmployeeWorkload(employees.find(e => e.name === item.employee).id);
                                    const status = getProjectWorkloadStatus(empWorkload.totalEffort);
                                    return status.charAt(0).toUpperCase() + status.slice(1);
                                })()}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="toggleWeekDetails(${index})" style="background: #3b82f6; color: white; padding: 3px 6px; border: none; border-radius: 3px; font-size: 11px; cursor: pointer; margin-right: 4px; font-weight: 500; width: fit-content;">View Weeks</button>
                            <button onclick="toggleRecordDetails(${index})" style="background: #8b5cf6; color: white; padding: 3px 6px; border: none; border-radius: 3px; font-size: 11px; cursor: pointer; font-weight: 500; width: fit-content;">View Records</button>
                        </td>
                    </tr>
                    <tr id="week-details-${index}" style="display: none;">
                        <td colspan="7" style="padding: 0; background: #f1f5f9;">
                            <div style="padding: 16px; margin: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h4 style="margin: 0; color: #1e3a8a;">Weekly Breakdown:</h4>
                                    <button onclick="downloadWeekDetails(${index})" style="background: #10b981; color: white; padding: 3px 6px; border: none; border-radius: 3px; font-size: 10px; cursor: pointer; font-weight: 500; width: fit-content;">Download Master</button>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                                    ${item.weekDetails.map(week => 
                                        `<div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0; text-align: center;">
                                            <div style="font-weight: 600; color: #374151;">${week.week}</div>
                                            <div style="color: #1e3a8a; font-weight: 700;">${week.effort}d</div>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr id="record-details-${index}" style="display: none;">
                        <td colspan="7" style="padding: 0; background: #f8fafc;">
                            <div style="padding: 16px; margin: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h4 style="margin: 0; color: #1e3a8a;">Detailed Records:</h4>
                                    <button onclick="downloadRecordDetails(${index})" style="background: #10b981; color: white; padding: 3px 6px; border: none; border-radius: 3px; font-size: 10px; cursor: pointer; font-weight: 500; width: fit-content;">Download Master</button>
                                </div>
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px; overflow: hidden;">
                                    <thead>
                                        <tr style="background: #e2e8f0; color: #374151;">
                                            <th style="padding: 8px; text-align: left; font-size: 12px;">Employee</th>
                                            <th style="padding: 8px; text-align: left; font-size: 12px;">Department</th>
                                            <th style="padding: 8px; text-align: left; font-size: 12px;">Project</th>
                                            <th style="padding: 8px; text-align: center; font-size: 12px;">Type</th>
                                            <th style="padding: 8px; text-align: center; font-size: 12px;">Week</th>
                                            <th style="padding: 8px; text-align: center; font-size: 12px;">Days</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${item.weekDetails.map((week, wIndex) => {
                                            const wRowStyle = wIndex % 2 === 0 ? 'background: #f8fafc;' : 'background: white;';
                                            return `<tr style="${wRowStyle}">
                                                <td style="padding: 8px; font-size: 12px;">${item.employee}</td>
                                                <td style="padding: 8px; font-size: 12px;">${item.department}</td>
                                                <td style="padding: 8px; font-size: 12px;">${item.project}</td>
                                                <td style="padding: 8px; text-align: center; font-size: 12px;">${item.projectType}</td>
                                                <td style="padding: 8px; text-align: center; font-size: 12px;">${week.week}</td>
                                                <td style="padding: 8px; text-align: center; font-size: 12px; font-weight: 600;">${week.effort}d</td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            document.getElementById('projectWorkloadTable').innerHTML = tableHtml;
        }
        
        function toggleWeekDetails(index) {
            const detailsRow = document.getElementById(`week-details-${index}`);
            detailsRow.style.display = detailsRow.style.display === 'none' ? 'table-row' : 'none';
        }
        
        function toggleRecordDetails(index) {
            const recordRow = document.getElementById(`record-details-${index}`);
            recordRow.style.display = recordRow.style.display === 'none' ? 'table-row' : 'none';
        }
        
        let projectWorkloadGlobalData = [];
        
        function downloadWeekDetails(index) {
            const item = projectWorkloadGlobalData[index];
            if (!item) return;
            
            let csvContent = 'Employee,Department,Project,Type,Week,Days\n';
            
            item.weekDetails.forEach(week => {
                csvContent += `"${item.employee}","${item.department}","${item.project}","${item.projectType}","${week.week}","${week.effort}d"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${item.employee}_${item.project}_weekly.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function downloadRecordDetails(index) {
            const item = projectWorkloadGlobalData[index];
            if (!item) return;
            
            let csvContent = 'Employee,Department,Project,Type,Week,Number of Days\n';
            
            item.weekDetails.forEach(week => {
                csvContent += `"${item.employee}","${item.department}","${item.project}","${item.projectType}","${week.week}","${week.effort}d"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${item.employee}_${item.project}_records.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function getProjectEmployeeWorkload(employeeId) {
            const employeeAssignments = assignments.filter(a => a.employeeId === employeeId);
            let totalEffort = 0;
            
            employeeAssignments.forEach(assignment => {
                const projectEfforts = efforts.filter(e => e.employeeId === employeeId && e.projectId === assignment.projectId);
                totalEffort += projectEfforts.reduce((sum, e) => sum + (parseFloat(e.effort) || 0), 0);
            });
            
            return { totalEffort };
        }
        
        function getProjectWorkloadStatus(totalEffort) {
            const normalWorkload = 22;
            if (totalEffort > normalWorkload) return 'overloaded';
            if (totalEffort < normalWorkload) return 'underutilized';
            return 'normal';
        }
        
        function downloadProjectWorkloadExcel() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            let filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            // Apply same filters as the table
            const projectDepartment = document.getElementById('projectDepartmentFilter').value;
            const projectEmployee = document.getElementById('projectEmployeeFilter').value;
            const projectProject = document.getElementById('projectProjectFilter').value;
            
            if (projectDepartment) {
                filteredEmployees = filteredEmployees.filter(emp => emp.department === projectDepartment);
            }
            if (projectEmployee) {
                filteredEmployees = filteredEmployees.filter(emp => emp.id == projectEmployee);
            }
            
            let csvContent = 'Employee,Department,Project,Type,Total Workload,Week Details\n';
            
            filteredEmployees.forEach(employee => {
                const employeeAssignments = assignments.filter(a => a.employeeId === employee.id);
                
                employeeAssignments.forEach(assignment => {
                    const project = projects.find(p => p.id === assignment.projectId);
                    if (!project || (projectProject && project.id != projectProject)) return;
                    
                    const projectEfforts = efforts.filter(e => e.employeeId === employee.id && e.projectId === assignment.projectId);
                    const totalEffort = projectEfforts.reduce((sum, e) => sum + e.effort, 0);
                    
                    if (totalEffort > 0) {
                        const projectType = project.type === 'presale' ? 'Non Project' : 'Paid Project';
                        const weekDetails = projectEfforts.map(e => {
                            const weekYear = Math.floor(e.week / 100);
                            const weekNum = e.week % 100;
                            const weekDate = getDateFromWeek(weekYear, weekNum);
                            const weekOfMonth = Math.ceil(weekDate.getDate() / 7);
                            return `${weekYear}/${String(weekDate.getMonth() + 1).padStart(2, '0')}/W${weekOfMonth}:${e.effort}d`;
                        }).join('; ');
                        
                        csvContent += `"${employee.name}","${employee.department}","${project.name}","${projectType}","${totalEffort}d","${weekDetails}"\n`;
                    }
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'employee_project_workload.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function updateProjectFilters() {
            // Update department filter
            const projectDeptFilter = document.getElementById('projectDepartmentFilter');
            const departments = [...new Set(employees.map(emp => emp.department))];
            projectDeptFilter.innerHTML = '<option value="">All Departments</option>' +
                departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
            
            // Update employee filter
            const projectEmpFilter = document.getElementById('projectEmployeeFilter');
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const assignedEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            projectEmpFilter.innerHTML = '<option value="">All Employees</option>' +
                assignedEmployees.map(emp => `<option value="${emp.id}">${emp.name} (${emp.department})</option>`).join('');
            
            // Update project filter
            const projectProjFilter = document.getElementById('projectProjectFilter');
            projectProjFilter.innerHTML = '<option value="">All Projects</option>' +
                projects.map(proj => `<option value="${proj.id}">${proj.name}</option>`).join('');
        }
        
        function navigateWithTransition(url) {
            document.body.style.opacity = '0';
            document.body.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }
        
        // Logout function with smooth delay
        function logout() {
            // Add visual feedback
            const logoutBtn = event.target;
            const originalText = logoutBtn.textContent;
            logoutBtn.textContent = '🔄 Logging out...';
            logoutBtn.style.opacity = '0.7';
            logoutBtn.disabled = true;
            
            // Smooth delay for better UX
            setTimeout(() => {
                navigateWithTransition('/logout');
            }, 800);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('a[href]:not([onclick])');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.href && !this.href.includes('#') && !this.target) {
                        e.preventDefault();
                        navigateWithTransition(this.href);
                    }
                });
            });
        });
        
        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/user`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                const user = await response.json();
                document.getElementById('userInfo').textContent = `Welcome, ${user.name}`;
                
                // Show admin button for admin users
                if (user.role === 'admin') {
                    document.getElementById('adminLink').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Fallback for offline mode - check localStorage or set default admin user
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    try {
                        const user = JSON.parse(currentUser);
                        document.getElementById('userInfo').textContent = `Welcome, ${user.name}`;
                        if (user.role === 'admin') {
                            document.getElementById('adminLink').style.display = 'inline-block';
                        }
                    } catch (parseError) {
                        console.error('Error parsing user data:', parseError);
                        // Set default admin user for testing
                        document.getElementById('userInfo').textContent = 'Welcome, Admin User';
                        document.getElementById('adminLink').style.display = 'inline-block';
                    }
                } else {
                    // No user data found - set default admin user for testing
                    console.log('No user data found, setting default admin user');
                    document.getElementById('userInfo').textContent = 'Welcome, Admin User';
                    document.getElementById('adminLink').style.display = 'inline-block';
                    
                    // Store default admin user in localStorage for consistency
                    const defaultUser = {
                        name: 'Admin User',
                        email: 'admin@company.com',
                        role: 'admin'
                    };
                    localStorage.setItem('currentUser', JSON.stringify(defaultUser));
                }
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadUserInfo();
        });
        
        // Chat functionality
        const chatSessionId = 'workload-summary-' + Date.now();
        
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            const isVisible = chatWindow.style.display === 'flex';
            chatWindow.style.display = isVisible ? 'none' : 'flex';
        }
        
        function closeChat() {
            document.getElementById('chatWindow').style.display = 'none';
        }
        
        async function clearConversation() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message assistant">
                    Hello! 👋 I'm your AI-powered Workload Assistant. I use AI to verify and answer resource allocation questions.
                    <br><br>I can assist you with:
                    <br>• Employee workload and availability (AI-verified)
                    <br>• Project assignments and allocation (AI-analyzed)
                    <br>• Department capacity analysis (AI-powered)
                    <br>• Team management insights (AI-generated)
                    <br><br>Try asking: "Who is working on Project TISCO?" or "Which department has the highest workload?"
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            showTyping();
            
            try {
                // Handle simple greetings first
                const greeting = handleSimpleGreetings(message);
                if (greeting) {
                    hideTyping();
                    addMessage(greeting, 'assistant');
                    return;
                }
                
                // Step 1: Send user question to AI for processing
                console.log('🤖 Step 1: Sending question to AI...');
                
                // Step 2: AI decides whether to answer directly or generate SQL
                const aiResponse = await processWithAI(message);
                
                hideTyping();
                addMessage(aiResponse, 'assistant');
                
            } catch (error) {
                hideTyping();
                console.error('Chat error:', error);
                
                // Provide helpful fallback response
                const fallbackResponse = getQueryExamplesResponse(message, error.message);
                addMessage(fallbackResponse, 'assistant');
            }
        }
        
        function handleSimpleGreetings(message) {
            const lowerMessage = message.toLowerCase().trim();
            
            const greetings = ['hi', 'hello', 'hey', 'good morning', 'good afternoon', 'good evening'];
            const thanks = ['thank you', 'thanks', 'thx'];
            const goodbyes = ['bye', 'goodbye', 'see you', 'farewell'];
            
            if (greetings.some(greeting => lowerMessage === greeting || lowerMessage.startsWith(greeting + ' '))) {
                return "Hello! 👋 Welcome to the AI-powered Workload Assistant. I use AI to verify and answer resource allocation questions.\n\nI can assist you with:\n• Employee workload and availability (AI-verified)\n• Project assignments and allocation (AI-analyzed)\n• Department capacity analysis (AI-powered)\n• Team management insights (AI-generated)\n\nWhat would you like to know about your resources today?";
            }
            
            if (thanks.some(thank => lowerMessage.includes(thank))) {
                return "You're welcome! 😊 I'm always here to help with your resource allocation needs using AI verification. Feel free to ask me anything about workloads, projects, or team capacity.";
            }
            
            if (goodbyes.some(goodbye => lowerMessage.includes(goodbye))) {
                return "Goodbye! 👋 Thank you for using the AI-powered Workload Assistant. Come back anytime you need help with resource allocation or workload analysis.";
            }
            
            return null;
        }
        
        async function processWithAI(userQuestion) {
            try {
                console.log('🤖 Step 1: Using AI to generate SQL query...');
                
                // Step 1: Use AI to generate SQL query
                const sqlPrompt = `You are an AI SQL expert for a Resource Allocation System. Convert the user's question into a SQL query.

User Question: "${userQuestion}"

Database Schema:
Tables:
- employees (id, name, department, email)
- projects (id, name, type, description)
- efforts (id, employeeId, projectId, week, effort)
- project_assignments (id, employeeId, projectId)

Common Queries:
- Who works on project: SELECT e.name, e.department FROM employees e JOIN project_assignments pa ON e.id = pa.employeeId JOIN projects p ON pa.projectId = p.id WHERE p.name LIKE '%TISCO%'
- Department workload: SELECT e.department, SUM(ef.effort) as total FROM employees e JOIN efforts ef ON e.id = ef.employeeId GROUP BY e.department ORDER BY total DESC
- Employee workload: SELECT e.name, SUM(ef.effort) as total FROM employees e JOIN efforts ef ON e.id = ef.employeeId GROUP BY e.id ORDER BY total DESC

Generate a SQL query to answer the question. If you cannot generate a valid SQL query, respond with "NO_SQL".

SQL Query:`;
                
                const sqlResponse = await callOpenAI(sqlPrompt);
                console.log('🗄️ AI SQL response:', sqlResponse);
                
                if (sqlResponse.includes('NO_SQL')) {
                    console.log('❌ AI could not generate SQL, using fallback');
                    return await fallbackToWorkloadAPI(userQuestion);
                }
                
                // Extract SQL query
                const sqlQuery = sqlResponse.replace(/```sql/g, '').replace(/```/g, '').trim();
                console.log('🗄️ AI generated SQL query:', sqlQuery);
                
                // Step 2: Execute SQL query against database
                const queryResult = await executeSQLQuery(sqlQuery);
                
                if (queryResult.error) {
                    console.log('❌ SQL execution failed, using fallback');
                    return await fallbackToWorkloadAPI(userQuestion);
                }
                
                console.log('📊 Using AI to summarize query results...');
                
                // Step 3: Use AI to summarize the results
                const summaryPrompt = `User asked: "${userQuestion}"

SQL Query: ${sqlQuery}
Query Results: ${JSON.stringify(queryResult.data, null, 2)}

Provide a clear, helpful answer based on this data. Keep it concise and directly answer their question.

Answer:`;
                
                const summary = await callOpenAI(summaryPrompt);
                console.log('✅ AI generated summary of results');
                return summary;
                
            } catch (error) {
                console.error('❌ AI processing error:', error);
                return await fallbackToWorkloadAPI(userQuestion);
            }
        }
        
        async function callOpenAI(prompt) {
            try {
                const response = await fetch(`${API_BASE}/workload-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: prompt
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Workload API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.analysis) {
                    return data.analysis;
                } else {
                    throw new Error('No analysis received from workload API');
                }
            } catch (error) {
                console.error('Workload API call failed:', error.message);
                return generateIntelligentResponse(prompt);
            }
        }
        
        function getSimpleAIResponse(prompt) {
            return generateIntelligentResponse(prompt);
        }
        
        function generateIntelligentResponse(query) {
            const lowerQuery = query.toLowerCase();
            
            // Greeting responses
            if (lowerQuery.includes('hello') || lowerQuery.includes('hi') || lowerQuery.includes('hey')) {
                const greetings = [
                    "Hello! I'm your AI-powered Workload Assistant. I can help you analyze resource allocation, manage team capacity, and optimize project assignments. What would you like to know about your team's workload?",
                    "Hi there! Welcome to your intelligent resource allocation assistant. I'm here to help you optimize team workloads and project assignments. How can I assist you today?",
                    "Hey! Ready to optimize your team's workload? I can help you find available capacity, manage overloaded employees, and balance project assignments. What's on your mind?"
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }
            
            // Resource availability queries
            if (lowerQuery.includes('available') || lowerQuery.includes('capacity') || lowerQuery.includes('free')) {
                const responses = [
                    "🔍 Finding Available Capacity:\n\n• Look for employees with <5 days weekly workload in the 'Underutilized' section\n• Use filters to view specific departments or time periods\n• Check the workload visualization charts for quick capacity overview\n• Consider redistributing tasks from overloaded team members\n• Monitor department-level capacity to identify bottlenecks\n\n💡 Pro Tip: Maintain 10-15% buffer capacity for urgent requests.",
                    "👥 Available Team Capacity Analysis:\n\n• Review the 'Underutilized' employees in your dashboard\n• Filter by department to find specific skill sets\n• Use the bar chart to visually identify capacity gaps\n• Cross-reference with project timelines for optimal allocation\n• Consider skill development opportunities for available staff\n\n✨ Smart Tip: Available capacity is your competitive advantage!"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // Overload management queries
            if (lowerQuery.includes('overload') || lowerQuery.includes('busy') || lowerQuery.includes('too much work')) {
                const responses = [
                    "⚠️ Managing Overloaded Employees (>5 days/week):\n\n1. Identify Root Causes: Check which projects are causing the overload\n2. Redistribute Tasks: Move non-critical work to available team members\n3. Timeline Adjustment: Consider extending project deadlines if possible\n4. Priority Review: Discuss project priorities with stakeholders\n5. Trend Monitoring: Track workload patterns to prevent future overloads\n\n🎯 Goal: Aim for sustainable 5-day weekly allocations across your team.",
                    "🚀 Overload Resolution Strategy:\n\n• Immediate Action: Identify tasks that can be delayed or delegated\n• Resource Rebalancing: Move work to team members with capacity\n• Process Optimization: Look for inefficiencies in current workflows\n• Stakeholder Communication: Set realistic expectations with clients\n• Prevention Planning: Implement early warning systems for future overloads\n\n📊 Remember: Sustainable workloads lead to better quality and team satisfaction."
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // Project assignment queries
            if (lowerQuery.includes('project') && (lowerQuery.includes('assign') || lowerQuery.includes('allocation'))) {
                return "📋 Optimal Project Allocation Strategy:\n\n• Skill Matching: Align employee expertise with project requirements\n• Load Balancing: Distribute work evenly (target: 5 days/week per person)\n• Cross-functional Planning: Consider department capacity for multi-team projects\n• Progress Tracking: Monitor project advancement and adjust allocations\n• Visibility Maintenance: Keep all stakeholders informed of assignments\n\n🔄 Remember: Regular rebalancing ensures optimal resource utilization.";
            }
            
            // Team management queries
            if (lowerQuery.includes('team') || lowerQuery.includes('department') || lowerQuery.includes('manage')) {
                return "👥 Effective Team Workload Management:\n\n• Regular Monitoring: Review individual and department capacity weekly\n• Data-Driven Decisions: Use dashboard insights for workload balancing\n• Mentorship Opportunities: Leverage high-performers to guide others\n• Seasonal Planning: Anticipate and prepare for workload variations\n• Clear Communication: Maintain transparency about capacity and priorities\n\n📊 Use the dashboard filters and reports to get detailed team insights.";
            }
            
            // Specific employee queries
            if (lowerQuery.includes('who is working') || lowerQuery.includes('which employees') || lowerQuery.includes('project team')) {
                return "👤 Finding Project Team Members:\n\n• Detailed Reports: Use the reports section to see project assignments\n• Project Filtering: Filter by project name to view all team members\n• Effort Levels: Check individual contribution levels and time allocation\n• Visual Charts: Use workload visualization for graphical team overview\n• Department View: See cross-departmental project involvement\n\n🔍 Navigate to the detailed reports section for comprehensive project team data.";
            }
            
            // Planning and optimization queries
            if (lowerQuery.includes('plan') || lowerQuery.includes('optimize') || lowerQuery.includes('improve')) {
                return "🎯 Resource Planning Best Practices:\n\n1. Historical Analysis: Study past workload patterns for future predictions\n2. Buffer Capacity: Maintain 10-15% spare capacity for urgent work\n3. Cross-Training: Develop versatile team members for flexibility\n4. Hiring Insights: Use workload data to inform recruitment decisions\n5. Priority Management: Regularly review and adjust project importance\n\n📈 Continuous optimization leads to better team performance and satisfaction.";
            }
            
            // Workload analysis queries
            if (lowerQuery.includes('workload') || lowerQuery.includes('analysis') || lowerQuery.includes('summary')) {
                return "📊 Workload Analysis Insights:\n\n• Dashboard Metrics: Review team capacity utilization patterns\n• Balance Assessment: Compare overloaded vs. underutilized employees\n• Department Analysis: Identify resource gaps across teams\n• Project Distribution: Ensure balanced assignment across initiatives\n• Project Types: Consider both paid and non-paid work in planning\n\n💡 Use the time period filters to analyze trends and make informed decisions.";
            }
            
            // Employee count queries
            if (lowerQuery.includes('how many employee') || lowerQuery.includes('total employee') || lowerQuery.includes('employee count') || lowerQuery.includes('number of employee')) {
                const totalEmployees = employees.length;
                const assignedEmployees = [...new Set(assignments.map(a => a.employeeId))].length;
                const departments = [...new Set(employees.map(e => e.department))];
                
                return `👥 **Employee Count in System:**\n\n• **Total Employees:** ${totalEmployees}\n• **Assigned to Projects:** ${assignedEmployees}\n• **Departments:** ${departments.length} (${departments.join(', ')})\n\n📊 Use the dashboard filters to analyze specific departments or view detailed employee workloads.`;
            }
            
            // Time-based availability queries
            if (lowerQuery.includes('availability') && (lowerQuery.includes('january') || lowerQuery.includes('month'))) {
                const empAvailability = employees.map(emp => {
                    let empEfforts = efforts.filter(e => e.employeeId === emp.id);
                    // Filter for January 2025 (weeks 202501-202504)
                    if (lowerQuery.includes('january') || lowerQuery.includes('month1')) {
                        empEfforts = empEfforts.filter(e => e.week >= 202501 && e.week <= 202504);
                    }
                    const total = empEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                    const available = Math.max(0, 20 - total); // 20 days in month
                    return { name: emp.name, department: emp.department, total, available };
                }).sort((a, b) => b.available - a.available);
                
                const monthName = lowerQuery.includes('january') ? 'January 2025' : 'the specified month';
                let response = `📅 **Employee Availability in ${monthName}:**\n\n`;
                empAvailability.forEach(emp => {
                    response += `• **${emp.name}** (${emp.department}): ${emp.available} days available (${emp.total} days allocated)\n`;
                });
                return response;
            }
            
            // Specific data queries
            if (lowerQuery.includes('highest workload') || lowerQuery.includes('most busy')) {
                return "📈 Finding Highest Workload:\n\n• Employee View: Sort employees by total workload in the detailed reports\n• Department Comparison: Check department-level workload summaries\n• Project Analysis: Identify which projects require the most resources\n• Time Period: Use filters to analyze specific weeks, months, or quarters\n• Visual Charts: Bar charts show workload distribution clearly\n\n🔍 Check the workload visualization section for immediate insights.";
            }
            
            // Help and guidance queries
            if (lowerQuery.includes('help') || lowerQuery.includes('how to') || lowerQuery.includes('guide')) {
                return "🤖 AI Workload Assistant Help:\n\nI can assist you with:\n• Employee Availability: Find team members with spare capacity\n• Overload Management: Strategies for managing busy employees\n• Project Assignments: Optimal allocation recommendations\n• Team Analysis: Department and individual workload insights\n• Planning Advice: Best practices for resource management\n\n❓ Try asking specific questions like:\n• 'Which employees have available capacity?'\n• 'How can I manage overloaded team members?'\n• 'What's the workload by department?'";
            }
            
            // Random varied default responses
            const defaultResponses = [
                "🤖 AI Workload Assistant Ready!\n\nI'm here to help you optimize your team's resource allocation. I can provide insights on:\n\n• 👥 Employee availability and capacity\n• ⚠️ Managing overloaded team members\n• 📋 Project assignment strategies\n• 🏢 Department workload analysis\n• 🎯 Team management best practices\n\n💬 Ask me anything about your team's workload!",
                "🚀 Resource Optimization Assistant Active!\n\nI specialize in helping you:\n\n• 🔍 Identify available team capacity\n• ⚖️ Balance workloads across projects\n• 📈 Analyze department performance\n• 📊 Track resource utilization trends\n• 🎯 Optimize project assignments\n\n💡 What resource challenge can I help you solve today?",
                "🌟 Smart Workload Management at Your Service!\n\nI can help you with:\n\n• 👥 Team capacity planning and analysis\n• 📋 Strategic project resource allocation\n• 📉 Workload distribution optimization\n• 🏢 Cross-department resource insights\n• ⚡ Quick solutions for resource bottlenecks\n\n🚀 Ready to maximize your team's potential?"
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }
        
        async function executeSQLQuery(sqlQuery) {
            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sql: sqlQuery })
                });
                
                if (!response.ok) {
                    return executeLocalQuery(sqlQuery);
                }
                
                const data = await response.json();
                return { data: data.results || data, error: null };
            } catch (error) {
                return executeLocalQuery(sqlQuery);
            }
        }
        
        function executeLocalQuery(sqlQuery) {
            try {
                const lowerQuery = sqlQuery.toLowerCase();
                
                if (lowerQuery.includes('department') && lowerQuery.includes('sum')) {
                    const weekFilter = extractWeekFilter(lowerQuery);
                    const deptWorkload = {};
                    employees.forEach(emp => {
                        let empEfforts = efforts.filter(e => e.employeeId === emp.id);
                        if (weekFilter) empEfforts = empEfforts.filter(e => e.week === weekFilter);
                        const total = empEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                        deptWorkload[emp.department] = (deptWorkload[emp.department] || 0) + total;
                    });
                    
                    const results = Object.entries(deptWorkload)
                        .map(([dept, total]) => ({ department: dept, total }))
                        .sort((a, b) => b.total - a.total);
                    
                    return { data: results, error: null };
                }
                
                if (lowerQuery.includes('employee') && lowerQuery.includes('sum')) {
                    const weekFilter = extractWeekFilter(lowerQuery);
                    const empWorkload = employees.map(emp => {
                        let empEfforts = efforts.filter(e => e.employeeId === emp.id);
                        if (weekFilter) empEfforts = empEfforts.filter(e => e.week === weekFilter);
                        const total = empEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                        return { name: emp.name, department: emp.department, total };
                    }).sort((a, b) => b.total - a.total);
                    
                    return { data: empWorkload, error: null };
                }
                
                if (lowerQuery.includes('project') && lowerQuery.includes('sum')) {
                    const projWorkload = projects.map(proj => {
                        const projEfforts = efforts.filter(e => e.projectId === proj.id);
                        const total = projEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                        return { name: proj.name, type: proj.type, total };
                    }).sort((a, b) => b.total - a.total);
                    
                    return { data: projWorkload, error: null };
                }
                
                if (lowerQuery.includes('week') && lowerQuery.includes('group by')) {
                    const weeklyData = {};
                    efforts.forEach(e => {
                        weeklyData[e.week] = (weeklyData[e.week] || 0) + parseFloat(e.effort || 0);
                    });
                    
                    const results = Object.entries(weeklyData)
                        .map(([week, total]) => ({ week: parseInt(week), total }))
                        .sort((a, b) => a.week - b.week);
                    
                    return { data: results, error: null };
                }
                
                return { data: null, error: 'Query not supported locally' };
            } catch (error) {
                return { data: null, error: error.message };
            }
        }
        
        function extractWeekFilter(query) {
            const currentWeek = getCurrentWeekValue();
            if (query.includes('this week') || query.includes('current week')) {
                return currentWeek;
            }
            const weekMatch = query.match(/week\s*=\s*(\d+)/);
            return weekMatch ? parseInt(weekMatch[1]) : null;
        }
        
        async function fallbackToWorkloadAPI(userQuestion) {
            console.log('🔄 Using workload analysis API as fallback...');
            
            try {
                const response = await fetch(`${API_BASE}/workload-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: userQuestion
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Workload API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.analysis) {
                    return data.analysis;
                } else {
                    throw new Error('No analysis received from workload API');
                }
            } catch (error) {
                console.error('Workload API failed:', error);
                if (userQuestion.toLowerCase().includes('manage') && userQuestion.toLowerCase().includes('workload')) {
                    return "To manage team workload effectively: 1) Monitor each team member's capacity (aim for 5 days/week), 2) Redistribute tasks from overloaded to available team members, 3) Use data to identify bottlenecks and balance assignments across projects.";
                }
                return "I can only answer questions related to resource allocation and the database we have. Please ask me about employee workloads, project assignments, department capacity, or team management.";
            }
        }
        
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }
        
        function handleLocalWorkloadQuery(message) {
            const lowerMessage = message.toLowerCase();
            
            // Handle project employee queries ("Who is working on Project X?")
            if ((lowerMessage.includes('who') || lowerMessage.includes('which') || lowerMessage.includes('employees')) && 
                (lowerMessage.includes('working on') || lowerMessage.includes('assigned to') || lowerMessage.includes('on project'))) {
                return getProjectEmployees(message);
            }
            
            // Handle availability queries
            if (lowerMessage.includes('available') || lowerMessage.includes('room') || lowerMessage.includes('capacity') || lowerMessage.includes('free')) {
                return getAvailableEmployees();
            }
            
            // Handle overloaded queries
            if (lowerMessage.includes('overload') || lowerMessage.includes('busy') || lowerMessage.includes('full')) {
                return getOverloadedEmployees();
            }
            
            // Handle workload summary queries
            if (lowerMessage.includes('summary') || lowerMessage.includes('overview') || lowerMessage.includes('status')) {
                return getWorkloadSummary();
            }
            
            // Handle department queries
            if (lowerMessage.includes('department')) {
                return getDepartmentWorkloadAnalysis();
            }
            
            // Handle project queries
            if (lowerMessage.includes('project') && (lowerMessage.includes('highest') || lowerMessage.includes('most') || lowerMessage.includes('allocation'))) {
                return getProjectWorkloadAnalysis();
            }
            
            return null;
        }
        
        function getAvailableEmployees() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            const availableEmployees = [];
            
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                const status = getWorkloadStatus(workload.totalEffort);
                
                if (status === 'underutilized') {
                    const availableDays = 5 - workload.totalEffort;
                    availableEmployees.push({
                        name: emp.name,
                        department: emp.department,
                        currentWorkload: workload.totalEffort,
                        availableDays: availableDays,
                        projects: workload.projectBreakdown
                    });
                }
            });
            
            if (availableEmployees.length === 0) {
                return "Currently, no employees have available capacity this week. All employees are either at full capacity (5 days) or overloaded.";
            }
            
            let response = `📊 **Employees with Available Capacity This Week:**\n\n`;
            
            availableEmployees.forEach(emp => {
                response += `👤 **${emp.name}** (${emp.department})\n`;
                response += `   • Current workload: ${emp.currentWorkload} days\n`;
                response += `   • Available capacity: ${emp.availableDays} days\n`;
                if (emp.projects.length > 0) {
                    response += `   • Current projects: ${emp.projects.map(p => `${p.name} (${p.effort}d)`).join(', ')}\n`;
                }
                response += `\n`;
            });
            
            response += `💡 **Total available capacity: ${availableEmployees.reduce((sum, emp) => sum + emp.availableDays, 0)} days**`;
            
            return response;
        }
        
        function getOverloadedEmployees() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            const overloadedEmployees = [];
            
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                const status = getWorkloadStatus(workload.totalEffort);
                
                if (status === 'overloaded') {
                    const excessDays = workload.totalEffort - 5;
                    overloadedEmployees.push({
                        name: emp.name,
                        department: emp.department,
                        currentWorkload: workload.totalEffort,
                        excessDays: excessDays,
                        projects: workload.projectBreakdown
                    });
                }
            });
            
            if (overloadedEmployees.length === 0) {
                return "✅ Great news! No employees are currently overloaded. Everyone is within their 5-day weekly capacity.";
            }
            
            let response = `⚠️ **Overloaded Employees This Week:**\n\n`;
            
            overloadedEmployees.forEach(emp => {
                response += `👤 **${emp.name}** (${emp.department})\n`;
                response += `   • Current workload: ${emp.currentWorkload} days\n`;
                response += `   • Excess workload: ${emp.excessDays} days over capacity\n`;
                if (emp.projects.length > 0) {
                    response += `   • Projects: ${emp.projects.map(p => `${p.name} (${p.effort}d)`).join(', ')}\n`;
                }
                response += `\n`;
            });
            
            response += `🚨 **Total excess workload: ${overloadedEmployees.reduce((sum, emp) => sum + emp.excessDays, 0)} days**`;
            
            return response;
        }
        
        function getWorkloadSummary() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            let overloaded = 0, underutilized = 0, normal = 0;
            let totalWorkload = 0;
            
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                const status = getWorkloadStatus(workload.totalEffort);
                totalWorkload += workload.totalEffort;
                
                if (status === 'overloaded') overloaded++;
                else if (status === 'underutilized') underutilized++;
                else normal++;
            });
            
            const avgWorkload = filteredEmployees.length > 0 ? (totalWorkload / filteredEmployees.length).toFixed(1) : 0;
            const departments = [...new Set(filteredEmployees.map(emp => emp.department))];
            
            let response = `📊 **Workload Summary:**\n\n`;
            response += `👥 **Total Employees:** ${filteredEmployees.length}\n`;
            response += `🏢 **Departments:** ${departments.join(', ')}\n`;
            response += `📈 **Average Workload:** ${avgWorkload} days per employee\n\n`;
            
            response += `**Employee Status Breakdown:**\n`;
            response += `✅ Normal capacity (5 days): ${normal} employees\n`;
            response += `📉 Available capacity (<5 days): ${underutilized} employees\n`;
            response += `⚠️ Overloaded (>5 days): ${overloaded} employees\n\n`;
            
            response += `🎯 **Active Projects:** ${projects.map(p => p.name).join(', ')}`;
            
            return response;
        }
        
        function getDepartmentWorkloadAnalysis() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            if (filteredEmployees.length === 0) {
                return "No employee data available for department analysis.";
            }
            
            const departments = [...new Set(filteredEmployees.map(emp => emp.department))];
            
            const deptData = departments.map(dept => {
                const deptEmployees = filteredEmployees.filter(emp => emp.department === dept);
                let totalEffort = 0;
                let overloadedCount = 0;
                
                deptEmployees.forEach(emp => {
                    const workload = getEmployeeWorkload(emp.id);
                    totalEffort += workload.totalEffort;
                    if (getWorkloadStatus(workload.totalEffort) === 'overloaded') {
                        overloadedCount++;
                    }
                });
                
                const avgWorkload = deptEmployees.length > 0 ? (totalEffort / deptEmployees.length).toFixed(1) : 0;
                
                return {
                    department: dept,
                    totalEffort: Math.round(totalEffort * 10) / 10,
                    avgWorkload: parseFloat(avgWorkload),
                    employeeCount: deptEmployees.length,
                    overloadedCount
                };
            }).sort((a, b) => b.totalEffort - a.totalEffort);
            
            let response = `🏢 Department Workload Analysis:\n\n`;
            
            deptData.forEach((dept, index) => {
                const rank = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                response += `${rank} ${dept.department}\n`;
                response += `   • Total: ${dept.totalEffort}d\n`;
                response += `   • Average: ${dept.avgWorkload}d per employee\n`;
                response += `   • Team size: ${dept.employeeCount}\n`;
                if (dept.overloadedCount > 0) {
                    response += `   • ⚠️ Overloaded: ${dept.overloadedCount}\n`;
                }
                response += `\n`;
            });
            
            const highestDept = deptData[0];
            response += `💡 ${highestDept.department} has the highest workload (${highestDept.totalEffort} days).`;
            
            return response;
        }
        
        function getProjectEmployees(message) {
            // Extract project name from the message
            const projectName = extractProjectNameFromMessage(message);
            
            if (!projectName) {
                // If no specific project found, show all projects with employees
                return getAllProjectEmployees();
            }
            
            // Find the specific project
            const project = projects.find(p => 
                p.name.toLowerCase().includes(projectName.toLowerCase()) ||
                projectName.toLowerCase().includes(p.name.toLowerCase())
            );
            
            if (!project) {
                return `❌ **Project not found:** "${projectName}"\n\n📋 **Available projects:**\n${projects.map(p => `• ${p.name}`).join('\n')}`;
            }
            
            // Get employees working on this project
            const projectAssignments = assignments.filter(a => a.projectId === project.id);
            const projectEmployees = [];
            let totalProjectEffort = 0;
            
            projectAssignments.forEach(assignment => {
                const employee = employees.find(emp => emp.id === assignment.employeeId);
                const employeeEfforts = efforts.filter(e => 
                    e.employeeId === assignment.employeeId && e.projectId === project.id
                );
                const employeeTotal = employeeEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                
                if (employeeTotal > 0 && employee) {
                    totalProjectEffort += employeeTotal;
                    projectEmployees.push({
                        name: employee.name,
                        department: employee.department,
                        effort: employeeTotal,
                        status: getWorkloadStatus(getEmployeeWorkload(employee.id).totalEffort)
                    });
                }
            });
            
            if (projectEmployees.length === 0) {
                return `📋 **${project.name}**\n\n❌ No employees are currently assigned to this project or have recorded effort.`;
            }
            
            // Sort by effort (highest first)
            projectEmployees.sort((a, b) => b.effort - a.effort);
            
            const typeText = project.type === 'presale' ? 'Non Project' : 'Paid Project';
            let response = `📋 **${project.name}** (${typeText})\n\n`;
            response += `👥 **Team Members (${projectEmployees.length}):**\n\n`;
            
            projectEmployees.forEach((emp, index) => {
                const statusEmoji = emp.status === 'overloaded' ? '⚠️' : emp.status === 'underutilized' ? '📉' : '✅';
                response += `${index + 1}. **${emp.name}** (${emp.department})\n`;
                response += `   • Project effort: ${emp.effort} days\n`;
                response += `   • Status: ${statusEmoji} ${emp.status.charAt(0).toUpperCase() + emp.status.slice(1)}\n\n`;
            });
            
            response += `📊 **Project Summary:**\n`;
            response += `• Total effort: ${totalProjectEffort} days\n`;
            response += `• Average per person: ${(totalProjectEffort / projectEmployees.length).toFixed(1)} days`;
            
            return response;
        }
        
        function extractProjectNameFromMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Try to find project names in the message
            for (const project of projects) {
                const projectNameLower = project.name.toLowerCase();
                if (lowerMessage.includes(projectNameLower)) {
                    return project.name;
                }
            }
            
            // Look for common project patterns
            const projectPatterns = [
                /project\s+([a-zA-Z0-9\s]+?)(?:\?|$|\s+is|\s+has)/i,
                /on\s+([a-zA-Z0-9\s]+?)(?:\?|$|\s+project)/i,
                /"([^"]+)"/g,
                /'([^']+)'/g
            ];
            
            for (const pattern of projectPatterns) {
                const match = lowerMessage.match(pattern);
                if (match && match[1]) {
                    const extractedName = match[1].trim();
                    // Check if this matches any project
                    const foundProject = projects.find(p => 
                        p.name.toLowerCase().includes(extractedName) ||
                        extractedName.includes(p.name.toLowerCase())
                    );
                    if (foundProject) {
                        return foundProject.name;
                    }
                }
            }
            
            return null;
        }
        
        function getAllProjectEmployees() {
            let response = `📋 **All Project Assignments:**\n\n`;
            
            projects.forEach(project => {
                const projectAssignments = assignments.filter(a => a.projectId === project.id);
                const projectEmployees = [];
                
                projectAssignments.forEach(assignment => {
                    const employee = employees.find(emp => emp.id === assignment.employeeId);
                    const employeeEfforts = efforts.filter(e => 
                        e.employeeId === assignment.employeeId && e.projectId === project.id
                    );
                    const employeeTotal = employeeEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                    
                    if (employeeTotal > 0 && employee) {
                        projectEmployees.push({
                            name: employee.name,
                            department: employee.department,
                            effort: employeeTotal
                        });
                    }
                });
                
                if (projectEmployees.length > 0) {
                    const typeText = project.type === 'presale' ? 'Non Project' : 'Paid Project';
                    response += `**${project.name}** (${typeText})\n`;
                    response += `${projectEmployees.map(emp => `• ${emp.name} (${emp.department}) - ${emp.effort}d`).join('\n')}\n\n`;
                }
            });
            
            return response;
        }
        
        function getProjectWorkloadAnalysis() {
            const projectData = [];
            
            projects.forEach(project => {
                let totalEffort = 0;
                let employeeCount = 0;
                const employeeList = [];
                
                const projectAssignments = assignments.filter(a => a.projectId === project.id);
                projectAssignments.forEach(assignment => {
                    const employee = employees.find(emp => emp.id === assignment.employeeId);
                    const employeeEfforts = efforts.filter(e => 
                        e.employeeId === assignment.employeeId && e.projectId === project.id
                    );
                    const employeeTotal = employeeEfforts.reduce((sum, e) => sum + parseFloat(e.effort || 0), 0);
                    
                    if (employeeTotal > 0 && employee) {
                        totalEffort += employeeTotal;
                        employeeCount++;
                        employeeList.push(employee.name);
                    }
                });
                
                if (totalEffort > 0) {
                    projectData.push({
                        name: project.name,
                        type: project.type || 'project',
                        totalEffort,
                        employeeCount,
                        employees: employeeList
                    });
                }
            });
            
            projectData.sort((a, b) => b.totalEffort - a.totalEffort);
            
            let response = `📋 **Project Workload Analysis:**\n\n`;
            
            projectData.forEach((project, index) => {
                const rank = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                const typeText = project.type === 'presale' ? 'Non Project' : 'Paid Project';
                response += `${rank} **${project.name}** (${typeText})\n`;
                response += `   • Total allocation: ${project.totalEffort} days\n`;
                response += `   • Employees assigned: ${project.employeeCount}\n`;
                response += `   • Team: ${project.employees.join(', ')}\n\n`;
            });
            
            const highestProject = projectData[0];
            response += `💡 **${highestProject.name}** has the highest allocation with ${highestProject.totalEffort} days across ${highestProject.employeeCount} employees.`;
            
            return response;
        }
        
        async function handleAISQLQuery(message) {
            try {
                const dbSchema = getDatabaseSchema();
                const examples = getQueryExamples();
                const sqlPrompt = `You are a SQL expert for a Resource Allocation System. Convert the user's natural language question into a SQL query.

${dbSchema}

${examples}

User Question: "${message}"

If you can generate a SQL query, respond with only the SQL query.
If you cannot understand the question or generate a query, respond with "CANNOT_GENERATE_SQL".`;
                
                const response = await callOpenAI(sqlPrompt);
                
                if (!response.ok) {
                    return getQueryExamplesResponse(message);
                }
                
                const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    return getQueryExamplesResponse(message);
                }
                
                const aiReply = data.choices[0].message.content;
                
                // Check if AI couldn't generate SQL
                if (aiReply.includes('CANNOT_GENERATE_SQL')) {
                    return getQueryExamplesResponse(message);
                }
                
                // Extract SQL query from AI response
                const sqlQuery = extractSQLQuery(aiReply);
                if (!sqlQuery) {
                    return getQueryExamplesResponse(message);
                }
                
                // Execute the SQL query
                const queryResult = await executeSQLQuery(sqlQuery);
                
                // If query execution failed, provide examples
                if (queryResult.error) {
                    return getQueryExamplesResponse(message, queryResult.error);
                }
                
                return formatQueryResult(queryResult, message);
                
            } catch (error) {
                console.error('AI SQL query error:', error);
                return getQueryExamplesResponse(message, error.message);
            }
        }
        
        function getDatabaseSchema() {
            return `DATABASE SCHEMA:

Tables:
1. employees (id, name, department, email)
2. projects (id, name, type, description)
3. efforts (id, employeeId, projectId, week, effort)
4. project_assignments (id, employeeId, projectId)

Time Format: week column uses YYYYWW format (e.g., 202501 = Week 1 of 2025)
Current week: ${getCurrentWeekValue()}

Example Queries:
- Department workload: SELECT e.department, SUM(ef.effort) as total FROM employees e JOIN efforts ef ON e.id = ef.employeeId GROUP BY e.department ORDER BY total DESC
- This week workload: SELECT e.name, SUM(ef.effort) as total FROM employees e JOIN efforts ef ON e.id = ef.employeeId WHERE ef.week = ${getCurrentWeekValue()} GROUP BY e.id ORDER BY total DESC
- Weekly trends: SELECT ef.week, SUM(ef.effort) as total FROM efforts ef GROUP BY ef.week ORDER BY ef.week`;
        }
        
        function getCurrentWeekValue() {
            const now = new Date();
            const year = now.getFullYear();
            const weekNum = getWeekNumber(now);
            return year * 100 + weekNum;
        }
        
        function getQueryExamples() {
            return `EXAMPLE QUERIES:

1. Available employees:
SELECT e.name, e.department, (5 - COALESCE(SUM(ef.effort), 0)) as available_days
FROM employees e
LEFT JOIN efforts ef ON e.id = ef.employeeId
GROUP BY e.id, e.name, e.department
HAVING COALESCE(SUM(ef.effort), 0) < 5;

2. Overloaded employees:
SELECT e.name, e.department, SUM(ef.effort) as total_effort
FROM employees e
JOIN efforts ef ON e.id = ef.employeeId
GROUP BY e.id, e.name, e.department
HAVING SUM(ef.effort) > 5;

3. Project workload:
SELECT p.name, p.type, SUM(ef.effort) as total_effort
FROM projects p
JOIN efforts ef ON p.id = ef.projectId
GROUP BY p.id, p.name, p.type;

4. Department summary:
SELECT e.department, COUNT(DISTINCT e.id) as employee_count, SUM(ef.effort) as total_effort
FROM employees e
JOIN efforts ef ON e.id = ef.employeeId
GROUP BY e.department;

5. Employees working on specific project:
SELECT e.name, e.department, ef.effort as project_effort
FROM employees e
JOIN efforts ef ON e.id = ef.employeeId
JOIN projects p ON ef.projectId = p.id
WHERE p.name LIKE '%PROJECT_NAME%'
ORDER BY ef.effort DESC;`;
        }
        
        function getQueryExamplesResponse(originalMessage, error = null) {
            let response = `I can only answer questions related to resource allocation and our database. `;
            
            if (error) {
                response += `There was an issue processing your question: ${error}\n\n`;
            }
            
            response += `Here are example questions I can help with:\n\n`;
            
            response += `**👥 Employee Availability:**\n`;
            response += `• "Who has available capacity this week?"\n`;
            response += `• "Show me employees with less than 5 days workload"\n`;
            response += `• "Which employees are overloaded?"\n\n`;
            
            response += `**🏢 Department Analysis:**\n`;
            response += `• "Which department has the highest workload?"\n`;
            response += `• "What's the workload by department?"\n`;
            response += `• "How many employees are in each department?"\n\n`;
            
            response += `**📋 Project Information:**\n`;
            response += `• "Which projects have the highest allocation?"\n`;
            response += `• "Who is working on Project TISCO?"\n`;
            response += `• "Show me all project workloads"\n\n`;
            
            response += `**📊 Workload Analysis:**\n`;
            response += `• "Show me John's current workload"\n`;
            response += `• "What projects is the Engineering team working on?"\n\n`;
            
            response += `Please ask me about employee workloads, project assignments, or department capacity.`;
            
            return response;
        }
        
        function extractSQLQuery(aiResponse) {
            // Extract SQL query from AI response
            const sqlPattern = /(?:```sql\s*)?(SELECT[\s\S]*?)(?:\s*```)?$/i;
            const match = aiResponse.match(sqlPattern);
            
            if (match) {
                return match[1].trim();
            }
            
            // Fallback: if response starts with SELECT, assume it's a query
            if (aiResponse.trim().toUpperCase().startsWith('SELECT')) {
                return aiResponse.trim();
            }
            
            return null;
        }
        
        async function executeSQLQuery(sqlQuery) {
            try {
                console.log('🗄️ Executing SQL:', sqlQuery);
                
                // Try to execute via API endpoint first
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        query: sqlQuery
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ SQL executed via API, rows:', result.data?.length || 0);
                    return result;
                }
                
                console.log('⚠️ API endpoint not available, using local processing...');
                
            } catch (error) {
                console.log('⚠️ API error:', error.message, '- using local processing...');
            }
            
            // Fallback to local data processing
            return executeLocalQuery(sqlQuery);
        }
        
        function executeLocalQuery(sqlQuery) {
            try {
                const query = sqlQuery.toLowerCase();
                
                // Enhanced pattern matching for SQL queries
                if (query.includes('available') || (query.includes('< 5') || query.includes('less than 5'))) {
                    return getAvailableEmployeesData();
                }
                
                if (query.includes('overload') || query.includes('> 5') || query.includes('greater than 5')) {
                    return getOverloadedEmployeesData();
                }
                
                if (query.includes('department') && (query.includes('sum') || query.includes('count') || query.includes('group'))) {
                    return getDepartmentData();
                }
                
                if (query.includes('project') && (query.includes('sum') || query.includes('total'))) {
                    return getProjectData();
                }
                
                if (query.includes('employee') && query.includes('effort')) {
                    return getWorkloadSummaryData();
                }
                
                // Try to extract specific employee or project names
                const employeeMatch = extractEmployeeName(query);
                if (employeeMatch) {
                    return getSpecificEmployeeData(employeeMatch);
                }
                
                const projectMatch = extractProjectName(query);
                if (projectMatch) {
                    return getSpecificProjectData(projectMatch);
                }
                
                return { 
                    error: 'Could not process query locally',
                    message: 'Query pattern not recognized. Please try a different question format.'
                };
                
            } catch (error) {
                return { error: 'Local query processing failed: ' + error.message };
            }
        }
        
        function extractEmployeeName(query) {
            const employeeNames = employees.map(emp => emp.name.toLowerCase());
            return employeeNames.find(name => query.includes(name));
        }
        
        function extractProjectName(query) {
            const projectNames = projects.map(proj => proj.name.toLowerCase());
            return projectNames.find(name => query.includes(name));
        }
        
        function getSpecificEmployeeData(employeeName) {
            const employee = employees.find(emp => emp.name.toLowerCase() === employeeName.toLowerCase());
            if (!employee) return { data: [], message: 'Employee not found' };
            
            const workload = getEmployeeWorkload(employee.id);
            const data = [{
                name: employee.name,
                department: employee.department,
                total_effort: workload.totalEffort,
                status: getWorkloadStatus(workload.totalEffort),
                projects: workload.projectBreakdown.map(p => `${p.name} (${p.effort}d)`).join(', ')
            }];
            
            return { data, query: `Employee details for ${employee.name}` };
        }
        
        function getSpecificProjectData(projectName) {
            const project = projects.find(proj => proj.name.toLowerCase() === projectName.toLowerCase());
            if (!project) return { data: [], message: 'Project not found' };
            
            let totalEffort = 0;
            let employeeCount = 0;
            const employeeList = [];
            
            const projectAssignments = assignments.filter(a => a.projectId === project.id);
            projectAssignments.forEach(assignment => {
                const employee = employees.find(emp => emp.id === assignment.employeeId);
                const employeeEfforts = efforts.filter(e => 
                    e.employeeId === assignment.employeeId && e.projectId === project.id
                );
                const employeeTotal = employeeEfforts.reduce((sum, e) => sum + e.effort, 0);
                
                if (employeeTotal > 0 && employee) {
                    totalEffort += employeeTotal;
                    employeeCount++;
                    employeeList.push(`${employee.name} (${employeeTotal}d)`);
                }
            });
            
            const data = [{
                project_name: project.name,
                project_type: project.type || 'project',
                total_effort: totalEffort,
                employee_count: employeeCount,
                employees: employeeList.join(', ')
            }];
            
            return { data, query: `Project details for ${project.name}` };
        }
        
        function getAvailableEmployeesData() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            const availableData = [];
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                if (workload.totalEffort < 5) {
                    availableData.push({
                        name: emp.name,
                        department: emp.department,
                        current_workload: workload.totalEffort,
                        available_days: 5 - workload.totalEffort
                    });
                }
            });
            
            return { data: availableData, query: sqlQuery };
        }
        
        function getOverloadedEmployeesData() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            const overloadedData = [];
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                if (workload.totalEffort > 5) {
                    overloadedData.push({
                        name: emp.name,
                        department: emp.department,
                        current_workload: workload.totalEffort,
                        excess_days: workload.totalEffort - 5
                    });
                }
            });
            
            return { data: overloadedData, query: sqlQuery };
        }
        
        function getWorkloadSummaryData() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            const summaryData = [];
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                summaryData.push({
                    name: emp.name,
                    department: emp.department,
                    total_effort: workload.totalEffort,
                    status: getWorkloadStatus(workload.totalEffort)
                });
            });
            
            return { data: summaryData, query: sqlQuery };
        }
        
        function getDepartmentData() {
            const departments = [...new Set(employees.map(emp => emp.department))];
            const deptData = [];
            
            departments.forEach(dept => {
                const deptEmployees = employees.filter(emp => emp.department === dept);
                let totalEffort = 0;
                let employeeCount = 0;
                
                deptEmployees.forEach(emp => {
                    const workload = getEmployeeWorkload(emp.id);
                    if (workload.totalEffort > 0) {
                        totalEffort += workload.totalEffort;
                        employeeCount++;
                    }
                });
                
                if (employeeCount > 0) {
                    deptData.push({
                        department: dept,
                        total_employees: employeeCount,
                        total_effort: totalEffort,
                        avg_effort: (totalEffort / employeeCount).toFixed(1)
                    });
                }
            });
            
            return { data: deptData, query: sqlQuery };
        }
        
        function getProjectData() {
            const projectData = [];
            
            projects.forEach(project => {
                let totalEffort = 0;
                let employeeCount = 0;
                
                const projectAssignments = assignments.filter(a => a.projectId === project.id);
                projectAssignments.forEach(assignment => {
                    const employeeEfforts = efforts.filter(e => 
                        e.employeeId === assignment.employeeId && e.projectId === project.id
                    );
                    const employeeTotal = employeeEfforts.reduce((sum, e) => sum + e.effort, 0);
                    if (employeeTotal > 0) {
                        totalEffort += employeeTotal;
                        employeeCount++;
                    }
                });
                
                if (totalEffort > 0) {
                    projectData.push({
                        project_name: project.name,
                        project_type: project.type || 'project',
                        total_effort: totalEffort,
                        employee_count: employeeCount
                    });
                }
            });
            
            return { data: projectData, query: sqlQuery };
        }
        
        function formatQueryResult(result, originalQuestion) {
            if (result.error) {
                return `❌ **Query Error:** ${result.error}\n\nUsing local data analysis instead.`;
            }
            
            if (!result.data || result.data.length === 0) {
                return `📊 **No data found** for your question: "${originalQuestion}"\n\nTry asking about employee availability, workload, or project information.`;
            }
            
            let response = `📊 **Analysis Result:** "${originalQuestion}"\n\n`;
            
            // Format the results in a readable way
            if (result.data.length === 1 && Object.keys(result.data[0]).length === 1) {
                // Single value result
                const value = Object.values(result.data[0])[0];
                response += `**Answer:** ${value}`;
            } else {
                // Table result
                const headers = Object.keys(result.data[0]);
                
                // Create a formatted table
                response += `**Results (${result.data.length} records):**\n\n`;
                result.data.forEach((row, index) => {
                    response += `**${index + 1}.** `;
                    headers.forEach(header => {
                        const value = row[header];
                        const displayHeader = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        response += `${displayHeader}: **${value}** | `;
                    });
                    response = response.slice(0, -3) + '\n'; // Remove last ' | '
                });
            }
            
            if (result.message) {
                response += `\n💡 **Note:** ${result.message}`;
            }
            
            return response;
        }
        
        function getWorkloadContext() {
            const assignedEmployeeIds = [...new Set(assignments.map(a => a.employeeId))];
            const filteredEmployees = employees.filter(emp => assignedEmployeeIds.includes(emp.id));
            
            let context = `This is a Resource Allocation System. Current workload data:\n`;
            context += `Total employees: ${filteredEmployees.length}\n`;
            
            filteredEmployees.forEach(emp => {
                const workload = getEmployeeWorkload(emp.id);
                const status = getWorkloadStatus(workload.totalEffort);
                const availableDays = status === 'underutilized' ? 5 - workload.totalEffort : 0;
                
                context += `${emp.name} (${emp.department}): ${workload.totalEffort}/5 days, ${status}`;
                if (availableDays > 0) context += `, ${availableDays} days available`;
                context += `\n`;
            });
            
            return context;
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Add keyboard shortcut for testing (Ctrl+T)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 't' && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                    e.preventDefault();
                    testWorkloadAssistant();
                }
            });
        });
        
        // Test function for workload assistant
        function testWorkloadAssistant() {
            console.log('🧪 Testing Workload Assistant...');
            
            // Test queries
            const testQueries = [
                'who has available capacity?',
                'show me overloaded employees',
                'what is the workload by department?',
                'which projects have the highest allocation?',
                'show me john\'s workload',
                'invalid query that should show examples'
            ];
            
            testQueries.forEach(async (query, index) => {
                console.log(`\n📝 Test ${index + 1}: "${query}"`);
                
                // Test local query handling
                const localResponse = handleLocalWorkloadQuery(query);
                if (localResponse) {
                    console.log('✅ Local query handled:', localResponse.substring(0, 100) + '...');
                    return;
                }
                
                // Test local SQL processing
                try {
                    const sqlResult = executeLocalQuery(`SELECT * FROM employees WHERE name LIKE '%${query}%'`);
                    console.log('✅ Local SQL processed:', sqlResult);
                } catch (error) {
                    console.log('❌ Local SQL failed:', error.message);
                }
                
                // Test example response
                const exampleResponse = getQueryExamplesResponse(query);
                console.log('✅ Example response generated:', exampleResponse.substring(0, 100) + '...');
            });
            
            // Test data functions
            console.log('\n🔍 Testing data functions...');
            console.log('Available employees:', getAvailableEmployeesData());
            console.log('Overloaded employees:', getOverloadedEmployeesData());
            console.log('Department data:', getDepartmentData());
            console.log('Project data:', getProjectData());
            
            console.log('\n✅ Workload Assistant test completed!');
        }
        

        
        // Debug function for manual testing
        window.debugCharts = function() {
            console.log('=== CHART DEBUG ===');
            console.log('Data loaded:', {
                employees: employees?.length || 0,
                projects: projects?.length || 0,
                efforts: efforts?.length || 0,
                assignments: assignments?.length || 0
            });
            
            if (employees?.length > 0) {
                const filteredEmployees = getFilteredEmployees();
                console.log('Filtered employees:', filteredEmployees.length);
                
                if (filteredEmployees.length > 0) {
                    const emp = filteredEmployees[0];
                    const workload = getEmployeeWorkload(emp.id);
                    console.log(`Sample workload for ${emp.name}:`, workload);
                    
                    // Check current filters
                    console.log('Current filters:', {
                        department: currentDepartment,
                        employee: currentEmployee,
                        project: currentProject,
                        period: currentPeriod
                    });
                }
            }
            
            // Force chart update
            updateBarChart();
            updatePieChart();
        };
        
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                const user = await response.json();
                document.getElementById('userInfo').textContent = `Welcome, ${user.name}`;
            } catch (error) {
                console.error('Error loading user info:', error);
                window.location.href = '/login.html';
            }
        }
        
        // Load data on page load
        loadData();
        loadUserInfo();
        
        console.log('💡 Use debugCharts() in console to troubleshoot chart issues');
        
        // Initialize detail filters after data loads
        setTimeout(() => {
            updateDetailFilters();
            updateProjectFilters();
            renderProjectWorkload();

        }, 1000);
    </script>
</body>
</html>